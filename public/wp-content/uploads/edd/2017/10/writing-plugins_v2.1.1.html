<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <style>
  html {
  	font-size: 100%;
  	overflow-y: scroll;
  	-webkit-text-size-adjust: 100%;
  	-ms-text-size-adjust: 100%;
  }
  
  body {
  	color: #272727;
  	font-family: Georgia, Palatino, "Palatino Linotype", Times, "Times New Roman", serif;
  	line-height: 1.7;
  	padding: 1em;
  	/*margin: auto;*/
  	max-width: 42em;
  	background: #ffffff;
  }
  
  a {
  	color: #0088cc;
  	text-decoration: none;
  }
  
  a:visited {
  	color: #0088cc;
  }
  
  a:hover {
  	color: #005580;
  }
  
  a:active {
  	color: #005580;
  }
  
  a:focus {
  	outline: thin dotted;
  }
  
  p {
  	margin: 0 0 1em;
  }
  
  img {
  	max-width: 100%;
  }
  
  h1, h2, h3, h4, h5, h6 {
  	line-height: 125%;
  	margin-top: 2em;
  	font-weight: normal;
  }
  
  p,
  h1, h2, h3 {
  	orphans: 3;
  	widows: 3;
  }
  
  h1, h2, h3 {
  	page-break-after: avoid;
  }
  
  h4, h5, h6 {
  	font-weight: bold;
  }
  
  h1 {
  	font-size: 2.5em;
  	margin-top: 0;
  	margin-bottom: 0;
  	padding-top: 0;
  	padding-bottom: 0;
  }
  
  h2 {
  	font-size: 1.8em;
  	margin-top: 0;
  	padding-top: 0;
  	page-break-before: always;
  }
  
  h3 {
  	font-size: 1.5em;
  }
  
  h4 {
  	font-size: 1.2em;
  }
  
  h5 {
  	font-size: 1em;
  }
  
  h6 {
  	font-size: 0.9em;
  }
  
  blockquote {
  	color: #666666;
  	margin: 0;
  	padding-left: 3em;
  	page-break-inside: avoid;
  	border-left: 0.5em #eee solid;
  }
  
  hr {
  	display: block;
  	height: 2px;
  	border: 0;
  	border-top: 1px solid #aaa;
  	border-bottom: 1px solid #eee;
  	margin: 1em 0;
  	padding: 0;
  }
  
  pre, code, kbd, samp {
  	color: #000;
  	font-family: monospace, monospace;
  	_font-family: 'courier new', monospace;
  	font-size: 0.98em;
  }
  
  pre {
  	padding: 0 0 1em;
  	page-break-inside: avoid !important;
  	white-space: pre;
  	white-space: pre-wrap !important;
  	word-wrap: break-word;
  }
  
  b, strong {
  	font-weight: bold;
  }
  
  dfn {
  	font-style: italic;
  }
  
  ins {
  	background: #ff9;
  	color: #000;
  	text-decoration: none;
  }
  
  mark {
  	background: #ff0;
  	color: #000;
  	font-style: italic;
  	font-weight: bold;
  }
  
  sub, sup {
  	font-size: 75%;
  	line-height: 0;
  	position: relative;
  	vertical-align: baseline;
  }
  
  sup {
  	top: -0.5em;
  }
  
  sub {
  	bottom: -0.25em;
  }
  
  ul, ol {
  	margin: 1em 0;
  	padding: 0 0 0 2em;
  }
  
  li p:last-child {
  	margin-bottom: 0;
  }
  
  ul ul, ol ol {
  	margin: .3em 0;
  }
  
  dl {
  	margin-bottom: 1em;
  }
  
  dt {
  	font-weight: bold;
  	margin-bottom: .8em;
  }
  
  dd {
  	margin: 0 0 .8em 2em;
  }
  
  dd:last-child {
  	margin-bottom: 0;
  }
  
  img {
  	border: 0;
  	-ms-interpolation-mode: bicubic;
  	vertical-align: middle;
  }
  
  figure {
  	display: block;
  	text-align: center;
  	margin: 1em 0;
  }
  
  figure img {
  	border: none;
  	margin: 0 auto;
  }
  
  figcaption {
  	font-size: 0.8em;
  	font-style: italic;
  	margin: 0 0 .8em;
  }
  
  table {
  	margin-bottom: 2em;
  	border-bottom: 1px solid #ddd;
  	border-right: 1px solid #ddd;
  	border-spacing: 0;
  	border-collapse: collapse;
  }
  
  table th {
  	padding: .2em 1em;
  	background-color: #eee;
  	border-top: 1px solid #ddd;
  	border-left: 1px solid #ddd;
  }
  
  table td {
  	padding: .2em 1em;
  	border-top: 1px solid #ddd;
  	border-left: 1px solid #ddd;
  	vertical-align: top;
  }
  
  .meta {
  	color: #666666;
  	margin-bottom: 0;
  }
  
  .author-img {
  	border-radius: 50%;
  	display: inline-block;
  	height: 200px;
  	width: 200px;
  	margin-left: auto;
  	margin-right: auto;
  }
  
  .break {
  	page-break-before: always;
  }
  
  @media print {
  	* {
  		background: transparent !important;
  		color: black !important;
  		filter: none !important;
  		-ms-filter: none !important;
  	}
  
  	body {
  		font-size: 12pt;
  		max-width: 100%;
  	}
  
  	a, a:visited {
  		text-decoration: underline;
  	}
  
  	hr {
  		height: 1px;
  		border: 0;
  		border-bottom: 1px solid black;
  	}
  
  	a[href]:after {
  		content: " (" attr(href) ")";
  	}
  
  	abbr[title]:after {
  		content: " (" attr(title) ")";
  	}
  
  	.ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after {
  		content: "";
  	}
  
  	pre, blockquote {
  		border: 1px solid #999;
  		padding-right: 1em;
  	}
  
  	tr, img {
  		page-break-inside: avoid;
  	}
  
  	img {
  		max-width: 100% !important;
  	}
  
  	@page :left {
  		margin: 15mm 20mm 15mm 10mm;
  }
  
  	@page :right {
  		margin: 15mm 10mm 15mm 20mm;
  }
  
  /*	p, h2, h3 {
  		orphans: 3;
  		widows: 3;
  	}
  
  	h2, h3 {
  		page-break-after: avoid;
  	}*/
  }
  body {
  	margin: 0 auto;
  }
  
  a {
  	word-wrap: break-word;
  }
  
  pre, code, kbd, samp {
  	white-space: pre-wrap;
  }
  
  code {
  	word-wrap: break-word;
  }
  </style>
</head>
<body>
<h1 id="writing-plugins">Writing Plugins</h1>
<p>By Chris Ferdinandi<br> Go Make Things, LLC<br> v2.1.1</p>
<p>Copyright 2017 Chris Ferdinandi and Go Make Things, LLC. All Rights Reserved.</p>
<div data-toc="">

</div>
<h2 id="intro">Intro</h2>
<p>In this guide, you’ll learn:</p>
<ul>
<li>How to write modular code.</li>
<li>How to scope code so that it can be dropped into any project.</li>
<li>How to expose public functions and APIs in your plugin.</li>
<li>How to let users pass in their own options and settings.</li>
<li>How to make your plugins work with module bundlers like WebPack and Browserify.</li>
</ul>
<h3 id="a-quick-word-about-browser-compatibility">A quick word about browser compatibility</h3>
<p>This guide makes heavy use of ECMAScript 5 (more commonly known as ES5) and ECMA 6 (ES6) methods and APIs.</p>
<p>My goal for browser support is IE9 and above. Each function or technique mentioned in this guide includes specific browser support information. For methods and APIs that don’t meet that standard, I also include information about polyfills—snippets of code that add support for features to browsers that don’t natively offer it.</p>
<p>You’ll never have to run a command line prompt, compile code, or learn a weird pseudo language (though you certain can if you want to).</p>
<p><em><strong>Note:</strong> You can extend support all the way back to IE7 with a polyfill service like polyfill.io<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>.</em></p>
<h3 id="using-the-code-in-this-guide">Using the code in this guide</h3>
<p>Unless otherwise noted, all of the code in this book is free to use under the MIT license. You can view of copy of the license at <a href="https://gomakethings.com/mit" class="uri">https://gomakethings.com/mit</a>.</p>
<p>Let’s get started!</p>
<h2 id="getting-started">Getting Started</h2>
<p>The title of this book is a lie.</p>
<p>By definition, plugins extend the functionality of a library or framework. They’re dependent on another body of code to work. jQuery plugins add features to jQuery, for example.</p>
<p>Since we’re working with vanilla JS, there are no dependencies. What we’re going to write aren’t plugins. They’re components. They’re modules. Standalone pieces of code you can drop in and out of any project.</p>
<p>That said, “plugin” is still the commonly used term, so I’ll continue to call what we’re writing plugins throughout the guide.</p>
<h3 id="converting-a-script-to-a-plugin">Converting a script to a plugin</h3>
<p>To help make the concepts in this guide stick better, we’ll be converting a simple accordion script into a plugin.</p>
<p>It uses anchor links with the <code>.accordion-toggle</code> to show and hide content with the <code>.accordion</code> class. The content ID matches the <code>href</code> of the anchor links. It uses a CSS class to toggle content visibility.</p>
<p><strong>HTML</strong></p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;accordion-toggle&quot;</span><span class="ot"> href=</span><span class="st">&quot;#content-1&quot;</span><span class="kw">&gt;</span>Show More 1<span class="kw">&lt;/a&gt;</span>

<span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;accordion&quot;</span><span class="ot"> id=</span><span class="st">&quot;content-1&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;p&gt;</span>Some content...<span class="kw">&lt;/p&gt;</span>
<span class="kw">&lt;/div&gt;</span>

<span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;accordion-toggle&quot;</span><span class="ot"> href=</span><span class="st">&quot;#content-2&quot;</span><span class="kw">&gt;</span>Show More 2<span class="kw">&lt;/a&gt;</span>

<span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;accordion&quot;</span><span class="ot"> id=</span><span class="st">&quot;content-2&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;p&gt;</span>Some more content...<span class="kw">&lt;/p&gt;</span>
<span class="kw">&lt;/div&gt;</span></code></pre></div>
<p><strong>CSS</strong></p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="fl">.accordion</span> <span class="kw">{</span>
    <span class="kw">display:</span> <span class="dt">none</span><span class="kw">;</span>
<span class="kw">}</span>

<span class="fl">.accordion.active</span> <span class="kw">{</span>
    <span class="kw">display:</span> <span class="dt">block</span><span class="kw">;</span>
<span class="kw">}</span></code></pre></div>
<p><strong>JavaScript</strong></p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Only run if the clicked link was an accordion toggle</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>)) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all toggle links, loop through them, and close them</span>
    <span class="kw">var</span> toggles <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> <span class="va">toggles</span>.<span class="at">length</span><span class="op">;</span> n<span class="op">++</span>) <span class="op">{</span>
        toggles[n].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area and toggle link</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>

<span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<p>Alright. Let’s get started!</p>
<h2 id="modular-code">Modular Code</h2>
<p>When you’re first learning JavaScript, it’s common to write your scripts as one long chunk of code.</p>
<p>For example, let’s take another look at our accordion script. All of the code is one giant function. Some of the code is repetitive, copy/pasted with one or two tweaks.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Only run if the clicked link was an accordion toggle</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>)) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all toggle links, loop through them, and close them</span>
    <span class="kw">var</span> toggles <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> <span class="va">toggles</span>.<span class="at">length</span><span class="op">;</span> n<span class="op">++</span>) <span class="op">{</span>
        toggles[n].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area and toggle link</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>

<span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<p>We can make this script easier to debug and maintain, and more DRY (an acronymn for Don’t Repeat Yourself), by breaking it up into smaller, more modular parts.</p>
<h3 id="modularizing-the-code">Modularizing the Code</h3>
<p>My approach: anything that’s more than two or three lines of code gets moved into its own function. Let’s modularize our accordion script a little.</p>
<h4 id="run-our-accordion-script.">1. Run our accordion script.</h4>
<p>We’ll move all of that code into it’s own function that we’ll call whenever a <code>click</code> event happens.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Run our accordion script</span>
<span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
    <span class="co">// Only run if the clicked link was an accordion toggle</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>)) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all toggle links, loop through them, and close them</span>
    <span class="kw">var</span> toggles <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> <span class="va">toggles</span>.<span class="at">length</span><span class="op">;</span> n<span class="op">++</span>) <span class="op">{</span>
        toggles[n].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area and toggle link</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="co">// Listen for click events</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<h4 id="check-if-its-already-expanded.">2. Check if it’s already expanded.</h4>
<p>Next, we’ll move the code to check if our content is already expanded into it’s own function, <code>isActive()</code>.</p>
<p>Currently, if the content is already open, we <code>return</code> afterwards to stop our script. That won’t work with our code in it’s function (we’ll only be ending our new modular function, not <code>runAccordion()</code>).</p>
<p>Instead, if the content <em>is</em> expanded, we’ll return <code>true</code>. When we run <code>isActive()</code>, we’ll set it as a variable. If it returns <code>true</code>, we’ll <code>return</code> inside <code>runAccordion()</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Check if the target content is already active</span>
<span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
    <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>)) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span>
<span class="op">};</span>

<span class="co">// Run our accordion script</span>
<span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
    <span class="co">// Only run if the clicked link was an accordion toggle</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
    <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all toggle links, loop through them, and close them</span>
    <span class="kw">var</span> toggles <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> <span class="va">toggles</span>.<span class="at">length</span><span class="op">;</span> n<span class="op">++</span>) <span class="op">{</span>
        toggles[n].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area and toggle link</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="co">// Listen for click events</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<h4 id="close-all-accordions.">3. Close all accordions.</h4>
<p>Finally, we’ll move our code to close all accordions and accordion toggles into their own function, <code>closeAccordions()</code>.</p>
<p>We’ll pass in the appropriate selector as an argument, and let the function do the heavy lifting. This let’s us remove some repeated code from our script.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Check if the target content is already active</span>
<span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
    <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>)) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
    <span class="op">}</span>
<span class="op">};</span>

<span class="co">// Close all accordions or accordion toggles</span>
<span class="kw">var</span> closeAccordions <span class="op">=</span> <span class="kw">function</span> (selector) <span class="op">{</span>
    <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        items[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>
<span class="op">};</span>

<span class="co">// Run our accordion script</span>
<span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
    <span class="co">// Only run if the clicked link was an accordion toggle</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
    <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Close all accordion content and toggles</span>
    <span class="at">closeAccordions</span>(<span class="st">&#39;.accordion&#39;</span>)<span class="op">;</span>
    <span class="at">closeAccordions</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span>

    <span class="co">// Open our target content area and toggle link</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="co">// Listen for click events</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<p>While our script is actually a few lines longer (mostly due to inline comments and documentation), it’s now more readable, and lets us quickly scan <code>runAccordion()</code> to understand how the script works.</p>
<h2 id="scoping-our-code">Scoping Our Code</h2>
<p>The biggest issue with our new, modular script is that all of our code is in the global scope.</p>
<p>If another script has functions named <code>isActive()</code> or <code>closeAccordions()</code>, for example, they’ll conflict with our functions in unexpected ways.</p>
<p>We want to pull our code out of the global scope. The simplest way to do that is by wrapping it in an IIFE, or Immediately Invoked Function Expression.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="op">;</span>(<span class="kw">function</span> (window<span class="op">,</span> document<span class="op">,</span> <span class="kw">undefined</span>) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Code goes here...</span>

<span class="op">}</span>)(window<span class="op">,</span> document)<span class="op">;</span></code></pre></div>
<p>An IIFE is an unnamed function that runs immediately. By wrapping you code in a function, you keep it out of the global scope.</p>
<p>You’ll notice I’m also including <code>use strict;</code> in my IIFE. This tells browsers to be less forgiving with bugs and errors, which sounds like a bad thing but helps us write better code.</p>
<p>Here’s what our script looks like now.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="op">;</span>(<span class="kw">function</span> (window<span class="op">,</span> document<span class="op">,</span> <span class="kw">undefined</span>) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Check if the target content is already active</span>
    <span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
        <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>)) <span class="op">{</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
            <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
        <span class="op">}</span>
    <span class="op">};</span>

    <span class="co">// Close all accordions or accordion toggles</span>
    <span class="kw">var</span> closeAccordions <span class="op">=</span> <span class="kw">function</span> (selector) <span class="op">{</span>
        <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
        <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            items[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="op">}</span>
    <span class="op">};</span>

    <span class="co">// Run our accordion script</span>
    <span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="co">// Only run if the clicked link was an accordion toggle</span>
        <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the target content</span>
        <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Prevent default link behavior</span>
        <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

        <span class="co">// If the content is already expanded, collapse it and quit</span>
        <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
        <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Close all accordion content and toggles</span>
        <span class="at">closeAccordions</span>(<span class="st">&#39;.accordion&#39;</span>)<span class="op">;</span>
        <span class="at">closeAccordions</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span>

        <span class="co">// Open our target content area and toggle link</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">};</span>

    <span class="co">// Listen for click events</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

<span class="op">}</span>)(window<span class="op">,</span> document)<span class="op">;</span></code></pre></div>
<p>As soon as this loads on the page, it will run.</p>
<h2 id="initializing-your-plugin">Initializing Your Plugin</h2>
<p>You may not always want your code to run as soon as it’s loaded. You may want to explicitly initialize by doing something like this:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">accordion</span>.<span class="at">init</span>()<span class="op">;</span></code></pre></div>
<p>You might also want to be able to run some of the other functions on demand, not just when the script normally runs them. For example, you might want to be able to open an accordion, or close all accordions and toggles, from another script.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">accordion</span>.<span class="at">closeAccordions</span>()<span class="op">;</span></code></pre></div>
<p>This can make your plugin so much more flexible and future-friendly.</p>
<p>On several of my scripts, I often get requests for features that don’t exist in the core plugin. Through these public functions, many of the requested features can be bolted on without having to touch the core plugin code at all.</p>
<p>To implement these features, we’ll use what’s known as a Revealing Module Pattern.</p>
<h3 id="the-revealing-module-pattern">The Revealing Module Pattern</h3>
<p>With a revealing module pattern, you assign an IIFE to a named function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> myPlugin <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// Your code...</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>Inside the IIFE, we’ll create an object. Any functions want to use outside of the plugin will be assigned as keys in the object, which we’ll return at the end of the plugin.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> myPlugin <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// Public APIs</span>
    <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

    <span class="co">// Private function</span>
    <span class="co">// This can only be run inside of the accordion() function</span>
    <span class="kw">var</span> someFunction <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="co">// Do stuff...</span>
    <span class="op">};</span>

    <span class="co">// Public function</span>
    <span class="co">// This can be run from other scripts</span>
    <span class="va">publicAPIs</span>.<span class="at">publicFunction</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="co">// Do other stuff.</span>
    <span class="op">};</span>

    <span class="co">// Return our public APIs</span>
    <span class="cf">return</span> publicAPIs<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h3 id="converting-our-accordion-plugin-to-a-revealing-module-pattern">Converting our Accordion Plugin to a Revealing Module Pattern</h3>
<p>Let’s convert our accordion plugin to a revealing module pattern. For our purposes, we want to:</p>
<ol style="list-style-type: decimal">
<li>Initialize our plugin before running it, which we’ll do by moving our event listener into a public <code>init()</code> function.</li>
<li>Make <code>closeAccordions()</code> a public API. For this, we’ll:
<ul>
<li>Rename <code>closeAccordions()</code> to <code>closeItems()</code>.</li>
<li>Create a new <code>closeAccordions()</code> function that calls <code>closeItems()</code> with the selectors for our content and toggles.</li>
<li>Call <code>publicAPIs.closeAccordions()</code> in <code>runAccordion()</code>.</li>
</ul></li>
</ol>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// Public APIs</span>
    <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

    <span class="co">// Check if the target content is already active</span>
    <span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
        <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>)) <span class="op">{</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
            <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
        <span class="op">}</span>
    <span class="op">};</span>

    <span class="co">// Close all items with a matching selector</span>
    <span class="kw">var</span> closeItems <span class="op">=</span> <span class="kw">function</span> (selector) <span class="op">{</span>
        <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
        <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            items[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="op">}</span>
    <span class="op">};</span>

    <span class="co">// Close all accordions and toggles</span>
    <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="at">closeItems</span>(<span class="st">&#39;.accordion&#39;</span>)<span class="op">;</span>
        <span class="at">closeItems</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span>
    <span class="op">};</span>

    <span class="co">// Run our accordion script</span>
    <span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="co">// Only run if the clicked link was an accordion toggle</span>
        <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the target content</span>
        <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Prevent default link behavior</span>
        <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

        <span class="co">// If the content is already expanded, collapse it and quit</span>
        <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
        <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Close all accordion content and toggles</span>
        <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span>()<span class="op">;</span>

        <span class="co">// Open our target content area and toggle link</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">};</span>

    <span class="co">// Initialize our plugin</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="co">// Listen for click events</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
    <span class="op">};</span>

    <span class="co">// Return our public APIs</span>
    <span class="cf">return</span> publicAPIs<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>One thing you might notice is that we’re using our own public methods inside private ones—for example, when we run <code>publicAPIs.closeAccordions()</code> inside <code>runAccordion()</code>.</p>
<p>You might also notice that we’re running a private method—<code>closeItems()</code>—inside our public <code>publicAPIs.closeAccordions()</code> method.</p>
<p>This approach is extremely flexible, letting you expose only the functions you want to for public use.</p>
<p>To use the our plugin, you would now run <code>accordion.init()</code>. You can also close all accordions dynamically from any other script by running <code>accordion.closeAccordions()</code>.</p>
<h3 id="feature-tests">Feature Tests</h3>
<p>If you’re using any functions that are only supported by modern browsers, it’s a good idea to check that they’re supported before initializing your plugin.</p>
<p>In the example below, we’re checking for <code>addEventListener</code> and <code>querySelector</code> support.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// ...</span>

    <span class="co">// Initialize our plugin</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Feature test</span>
        <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Listen for click events</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// ...</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h3 id="adding-an-initialization-class">Adding an initialization class</h3>
<p>One little thing I like to do in my plugins is add an initialization class. This is a class that gets added to the <code>&lt;html&gt;</code> element after the plugin has initialized. I can hook into in my CSS to make style changes based on whether or not a plugin is running.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// ...</span>

    <span class="co">// Initialize our plugin</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Feature test</span>
        <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Listen for click events</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="co">// Add our initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// ...</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h2 id="user-options">User Options</h2>
<p>To make your plugin for flexible, it’s a good idea to let users configure options. Looking at our accordion script, we might want to let users:</p>
<ul>
<li>Change the selectors for our accordions and toggles.</li>
<li>Change the class that get’s added and removed to something other than <code>.active</code> (to avoid conflicts with other styles).</li>
<li>Change the class that get’s added to the <code>document</code> element on initialization.</li>
</ul>
<h3 id="setting-up-defaults">Setting up defaults</h3>
<p>Someone using your plugin shouldn’t have to configure every options. In fact, it should work out-of-the-box without any configuration at all.</p>
<p>The first thing we need to do is setup defaults. We’ll create a <code>defaults</code> object to hold these values.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// Public APIs</span>
    <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

    <span class="co">// Defaults</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="co">// Selectors</span>
        <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
        <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

        <span class="co">// Classes</span>
        <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
    <span class="op">};</span>

    <span class="co">// ...</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h3 id="passing-in-options">Passing in options</h3>
<p>Next, we want to provide a way for plugin users to pass in their own options that override our defaults. We’ll add an <code>options</code> argument to our <code>init()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// Public APIs</span>
    <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

    <span class="co">// Defaults</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="co">// Selectors</span>
        <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
        <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

        <span class="co">// Classes</span>
        <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
    <span class="op">};</span>

    <span class="co">// ...</span>

    <span class="co">// Initialize our plugin</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

        <span class="co">// Feature test</span>
        <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Listen for click events</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="co">// Add our initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return our public APIs</span>
    <span class="cf">return</span> publicAPIs<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h3 id="merging-user-options-with-defaults">Merging user options with defaults</h3>
<p>Next, we need a way to merge our user’s options with the default values.</p>
<p>First, we’ll create a variable called <code>settings</code>. Then, we’ll use <code>extend()</code><a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>, a helper method I wrote, to merge the user options and defaults together and assign them to the <code>settings</code> variable.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// Variables</span>
    <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span> <span class="co">// Our public APIs</span>
    <span class="kw">var</span> settings<span class="op">;</span> <span class="co">// Settings</span>

    <span class="co">// Defaults</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="co">// Selectors</span>
        <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
        <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

        <span class="co">// Classes</span>
        <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
    <span class="op">};</span>

    <span class="co">// Merge two or more objects together</span>
    extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> extended <span class="op">=</span> <span class="op">{};</span>
        <span class="kw">var</span> deep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
        <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>

        <span class="co">// Check if a deep merge</span>
        <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>( arguments[<span class="dv">0</span>] ) <span class="op">===</span> <span class="st">&#39;[object Boolean]&#39;</span> ) <span class="op">{</span>
            deep <span class="op">=</span> arguments[<span class="dv">0</span>]<span class="op">;</span>
            i<span class="op">++;</span>
        <span class="op">}</span>

        <span class="co">// Merge the object into the extended object</span>
        <span class="kw">var</span> merge <span class="op">=</span> <span class="kw">function</span> (obj) <span class="op">{</span>
            <span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> obj) <span class="op">{</span>
                <span class="cf">if</span> (<span class="va">obj</span>.<span class="at">hasOwnProperty</span>(prop)) <span class="op">{</span>
                    <span class="co">// If property is an object, merge properties</span>
                    <span class="cf">if</span> (deep <span class="op">&amp;&amp;</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(obj[prop]) <span class="op">===</span> <span class="st">&#39;[object Object]&#39;</span>) <span class="op">{</span>
                        extended[prop] <span class="op">=</span> <span class="at">extend</span>(extended[prop]<span class="op">,</span> obj[prop])<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        extended[prop] <span class="op">=</span> obj[prop]<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Loop through each object and conduct a merge</span>
        <span class="cf">for</span> (<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">arguments</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            <span class="kw">var</span> obj <span class="op">=</span> arguments[i]<span class="op">;</span>
            <span class="at">merge</span>(obj)<span class="op">;</span>
        <span class="op">}</span>

        <span class="cf">return</span> extended<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// ...</span>

    <span class="co">// Initialize our plugin</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

        <span class="co">// Feature test</span>
        <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Merge user options with the defaults</span>
        settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

        <span class="co">// Listen for click events</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="co">// Add our initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return our public APIs</span>
    <span class="cf">return</span> publicAPIs<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>You may notice that we pass in <code>options</code> <em>or</em> an empty object when merging with the defaults.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span></code></pre></div>
<p>If the user doesn’t provide any options at all, the <code>options</code> value will be <code>null</code> and cause an error, so we provide an empty object as a fallback.</p>
<h3 id="reference-our-merged-settings">Reference our merged settings</h3>
<p>Finally, we need to reference our new merged <code>settings</code> variable throughout the script.</p>
<p>Since our selectors may not be a class, we can no longer rely on <code>classList.contains()</code> to check if an accordion toggle as clicked. We need to use the <code>matches()</code> method instead. While browser support for this goes back to IE9, older browsers used a vendor-prefixed version, so we need to include a polyfill<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> to standardize behavior across browsers.</p>
<p>We also now need to pass a class into the <code>closeItems()</code> function, since the active class could vary between accordion toggles and content.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// Element.matches() polyfill (simple version)</span>
    <span class="co">// https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Variables</span>
    <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span> <span class="co">// Our public APIs</span>
    <span class="kw">var</span> settings<span class="op">;</span> <span class="co">// Settings</span>

    <span class="co">// Defaults</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="co">// Selectors</span>
        <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
        <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

        <span class="co">// Classes</span>
        <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
    <span class="op">};</span>

    <span class="co">// Merge two or more objects together</span>
    extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> extended <span class="op">=</span> <span class="op">{};</span>
        <span class="kw">var</span> deep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
        <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>

        <span class="co">// Check if a deep merge</span>
        <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>( arguments[<span class="dv">0</span>] ) <span class="op">===</span> <span class="st">&#39;[object Boolean]&#39;</span> ) <span class="op">{</span>
            deep <span class="op">=</span> arguments[<span class="dv">0</span>]<span class="op">;</span>
            i<span class="op">++;</span>
        <span class="op">}</span>

        <span class="co">// Merge the object into the extended object</span>
        <span class="kw">var</span> merge <span class="op">=</span> <span class="kw">function</span> (obj) <span class="op">{</span>
            <span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> obj) <span class="op">{</span>
                <span class="cf">if</span> (<span class="va">obj</span>.<span class="at">hasOwnProperty</span>(prop)) <span class="op">{</span>
                    <span class="co">// If property is an object, merge properties</span>
                    <span class="cf">if</span> (deep <span class="op">&amp;&amp;</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(obj[prop]) <span class="op">===</span> <span class="st">&#39;[object Object]&#39;</span>) <span class="op">{</span>
                        extended[prop] <span class="op">=</span> <span class="at">extend</span>(extended[prop]<span class="op">,</span> obj[prop])<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        extended[prop] <span class="op">=</span> obj[prop]<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Loop through each object and conduct a merge</span>
        <span class="cf">for</span> (<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">arguments</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            <span class="kw">var</span> obj <span class="op">=</span> arguments[i]<span class="op">;</span>
            <span class="at">merge</span>(obj)<span class="op">;</span>
        <span class="op">}</span>

        <span class="cf">return</span> extended<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Check if the target content is already active</span>
    <span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
        <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)) <span class="op">{</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>
            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
        <span class="op">}</span>
    <span class="op">};</span>

    <span class="co">// Close all items with a matching selector</span>
    <span class="kw">var</span> closeItems <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> activeClass) <span class="op">{</span>
        <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
        <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            items[i].<span class="va">classList</span>.<span class="at">remove</span>(activeClass)<span class="op">;</span>
        <span class="op">}</span>
    <span class="op">};</span>

    <span class="co">// Close all accordions and toggles</span>
    <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorContent</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
        <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>
    <span class="op">};</span>

    <span class="co">// Run our accordion script</span>
    <span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
        <span class="co">// Only run if the clicked link was an accordion toggle</span>
        <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="at">matches</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span>)) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the target content</span>
        <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Prevent default link behavior</span>
        <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

        <span class="co">// If the content is already expanded, collapse it and quit</span>
        <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
        <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Close all accordion content and toggles</span>
        <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span>()<span class="op">;</span>

        <span class="co">// Open our target content area and toggle link</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
        <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>
    <span class="op">};</span>

    <span class="co">// Initialize our plugin</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>
        <span class="co">// Feature test</span>
        <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Merge user options with the defaults</span>
        settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

        <span class="co">// Listen for click events</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="co">// Add our initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">init</span><span class="op">;</span>
    <span class="op">};</span>

    <span class="co">// Return our public APIs</span>
    <span class="cf">return</span> publicAPIs<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h3 id="initializing-the-plugin-with-options">Initializing the plugin with options</h3>
<p>Now we’re ready to initialize our plugin with user options. Here’s an example.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">accordion</span>.<span class="at">init</span>(<span class="op">{</span>
    <span class="dt">toggleSelector</span><span class="op">:</span> <span class="st">&#39;[data-accordion-toggle]&#39;</span><span class="op">,</span>
    <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;is-open&#39;</span><span class="op">,</span>
    <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;accordion-init&#39;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<h2 id="events-and-callbacks">Events and Callbacks</h2>
<p>You can provide hooks developers can use to run code when key specific things happen in your plugin.</p>
<p>For example, when an accordion is opened, a developer may want to make an Ajax call to get content from another page and add it to the accordion. Or they may want to stop a video from playing when the accordion closes.</p>
<p>There are two ways to provide these hooks:</p>
<ol style="list-style-type: decimal">
<li>Callbacks</li>
<li>Events</li>
</ol>
<p>They both achieve the same goal, but work a little differently.</p>
<h3 id="callbacks">Callbacks</h3>
<p>A callback is a piece of code that runs at a specific time. In your plugin, you can let users pass callbacks in as an option.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Defaults</span>
<span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
    <span class="co">// Selectors</span>
    <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
    <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

    <span class="co">// Classes</span>
    <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
    <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
    <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span><span class="op">,</span>

    <span class="co">// Calbacks</span>
    <span class="dt">callbackOpen</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{},</span>
    <span class="dt">callbackClose</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{}</span>
<span class="op">};</span></code></pre></div>
<p>Then, you can run it at the appropriate time, and even pass in arguments that developers can use to in their callback.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Run our accordion script</span>
<span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// ...</span>

    <span class="co">// Open our target content area and toggle link</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
    <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>

    <span class="co">// Run our callback</span>
    <span class="co">// content = the accordion</span>
    <span class="co">// event.target = the toggle</span>
    <span class="va">settings</span>.<span class="at">callbackOpen</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>A developer might pass in a callback like this.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">accordion</span>.<span class="at">init</span>(<span class="op">{</span>
    <span class="co">// Autoplay an HTML video when the accordion opens</span>
    <span class="dt">callbackOpen</span><span class="op">:</span> <span class="kw">function</span> (content) <span class="op">{</span>
        <span class="kw">var</span> video <span class="op">=</span> <span class="va">content</span>.<span class="at">querySelector</span>(<span class="st">&#39;video&#39;</span>)<span class="op">;</span>
        <span class="cf">if</span> (video) <span class="op">{</span>
            <span class="va">video</span>.<span class="at">play</span>()<span class="op">;</span>
        <span class="op">}</span>
    <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<h3 id="events">Events</h3>
<p>Instead of passing in a callback, you can also emit a custom event that developers can listen for with <code>addEventListener()</code>.</p>
<p>The CustomEvent API provides a way to create custom events and attach data about the event. You can attach the event to the <code>window</code> for a global event (for example, after initializing the script). You can also attach the event to specific element (for example, the accordion being opened or closed).</p>
<h4 id="creating-a-custom-event">Creating a custom event</h4>
<p>Create a <code>new CustomEvent</code>, and pass in the name of the event. You can optionally pass in an object with options and details.</p>
<p>There are two standard options on events that you’re likely to change. Both are booleans with a default of <code>false</code>.</p>
<ul>
<li>If <code>bubbles</code> is <code>true</code>, an event will “bubble up” or propagate through all of the element’s parent elements<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a>.</li>
<li>If <code>cancelable</code> is <code>true</code>, the event can be cancelled via <code>preventDefault()</code>.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Dispatch a custom event</span>
<span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
    <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span>
<span class="op">}</span>)<span class="op">;</span>
<span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span></code></pre></div>
<p>You can also add additional details about the event under the <code>detail</code> property. These can be accessed under <code>event.detail</code> in your event listener.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Dispatch a custom event</span>
<span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
    <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
    <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
        <span class="dt">contentID</span><span class="op">:</span> <span class="va">content</span>.<span class="at">id</span>
    <span class="op">}</span>
<span class="op">}</span>)<span class="op">;</span>
<span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span></code></pre></div>
<h4 id="browser-compatibility">Browser Compatibility</h4>
<p>The Custom Event API works in all modern browsers, but has no IE support. You should wrap your event in an <code>if</code> statement to check that it’s supported.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Dispatch a custom event</span>
<span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
    <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
        <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
        <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
            <span class="dt">contentID</span><span class="op">:</span> <span class="va">content</span>.<span class="at">id</span>
        <span class="op">}</span>
    <span class="op">}</span>)<span class="op">;</span>
    <span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>You can also push support back to IE9 with a small polyfill.<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a></p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * CustomEvent() polyfill</span>
<span class="co"> * https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Polyfill</span>
<span class="co"> */</span>
(<span class="kw">function</span> () <span class="op">{</span>
    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>

    <span class="kw">function</span> <span class="at">CustomEvent</span>(event<span class="op">,</span> params) <span class="op">{</span>
        params <span class="op">=</span> params <span class="op">||</span> <span class="op">{</span> <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">cancelable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">detail</span><span class="op">:</span> <span class="kw">undefined</span> <span class="op">};</span>
        <span class="kw">var</span> evt <span class="op">=</span> <span class="va">document</span>.<span class="at">createEvent</span>(<span class="st">&#39;CustomEvent&#39;</span>)<span class="op">;</span>
        <span class="va">evt</span>.<span class="at">initCustomEvent</span>(event<span class="op">,</span> <span class="va">params</span>.<span class="at">bubbles</span><span class="op">,</span> <span class="va">params</span>.<span class="at">cancelable</span><span class="op">,</span> <span class="va">params</span>.<span class="at">detail</span>)<span class="op">;</span>
        <span class="cf">return</span> evt<span class="op">;</span>
    <span class="op">}</span>

    <span class="va">CustomEvent</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">window</span>.<span class="va">Event</span>.<span class="at">prototype</span><span class="op">;</span>
    <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">=</span> CustomEvent<span class="op">;</span>
<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h4 id="a-custom-event-example">A custom event example</h4>
<p>Here’s an example of a the custom event from above in our accordion script.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Run our accordion script</span>
<span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// ...</span>

    <span class="co">// Open our target content area and toggle link</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
    <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>

    <span class="co">// Dispatch a custom event</span>
    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
        <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
            <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
            <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                <span class="dt">contentID</span><span class="op">:</span> <span class="va">content</span>.<span class="at">id</span>
            <span class="op">}</span>
        <span class="op">}</span>)<span class="op">;</span>
        <span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
    <span class="op">}</span>

<span class="op">};</span></code></pre></div>
<p>And a developer might listen for it like this.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Listen for all accordionOpen events</span>
<span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>
    <span class="co">// Autoplay an HTML video when the accordion opens</span>
    <span class="kw">var</span> video <span class="op">=</span> <span class="va">event</span>.<span class="va">target</span>.<span class="at">querySelector</span>(<span class="st">&#39;video&#39;</span>)<span class="op">;</span>
    <span class="cf">if</span> (video) <span class="op">{</span>
        <span class="va">video</span>.<span class="at">play</span>()<span class="op">;</span>
    <span class="op">}</span>
<span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<h3 id="should-you-use-callbacks-events-or-both">Should you use callbacks, events, or both?</h3>
<p>So, which one should you use, when should you use it, and why?</p>
<p>I personally use events exclusively in my new plugins, and have started converting my older ones over from callbacks to events. They just provide so much more flexibility.</p>
<p>Callbacks require you to pass in a function at the time of initialization. With events, you can create multiple event listeners in multiple scripts, and they can be added at any time (both before and after initializing your script).</p>
<p>The one big downside to events is their asynchronous nature.</p>
<p>After the event is emitted, the plugin continues to run, and any listener events will run once the listener picks them up. Callbacks, on the otherhand, stop the plugin from doing anything else until the callback is run.</p>
<p>If you have a plugin where you want or need to prevent the plugin from continuing until any external hooks are run, callbacks are a better choice. Otherwise, I’d use custom events.</p>
<h2 id="destroying-the-plugin-initialization">Destroying the Plugin Initialization</h2>
<p>Sometimes, it’s helpful to provide a way for users to destroy your plugin after it’s been initialized.</p>
<p>This becomes a public function users can run that resets the <code>settings</code> variable, removes any event listeners, and restores any changes you’ve made to their original state.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// ...</span>

    <span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Only run if settings is set</span>
        <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Remove event listener</span>
        <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="co">// Remove the initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">init</span>)<span class="op">;</span>

        <span class="co">// Reset settings</span>
        settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// ...</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>For good measure, you should also call it whenever you run your <code>publicAPIs.init()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span>

    <span class="st">&#39;use strict;&#39;</span>

    <span class="co">// ...</span>

    <span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Only run if settings is set</span>
        <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Remove event listener</span>
        <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="co">// Remove the initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">init</span>)<span class="op">;</span>

        <span class="co">// Reset settings</span>
        settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Initialize our plugin</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

        <span class="co">// Feature test</span>
        <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Destroy any previous initializations</span>
        <span class="va">publicAPIs</span>.<span class="at">destroy</span>()<span class="op">;</span>

        <span class="co">// Merge user options with the defaults</span>
        settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

        <span class="co">// Listen for click events</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="co">// Add our initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">init</span><span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// ...</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h2 id="allow-multiple-instances-of-your-plugin-to-run-at-once">Allow multiple instances of your plugin to run at once</h2>
<p>Depending on what your plugin does, developers may want to run more than once instance of it at the same time.</p>
<p>For example, on a webpage with multiple accordions, a developer may want to use different selectors for some of them.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Initialize with defaults</span>
<span class="va">accordion</span>.<span class="at">init</span>()<span class="op">;</span>

<span class="co">// Initialize with a custom selector</span>
<span class="va">accordion</span>.<span class="at">init</span>(<span class="op">{</span>
    <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;[data-toggle]&#39;</span><span class="op">;</span>
<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>While you can pass in the selector as an option, you can only have once instance of our script running at a time.</p>
<p>In the example above, the custom selector initialization causes <code>accordion.destroy()</code> to run and destroys the first initialization. Even if you removed the automatic <code>destroy()</code>, our <code>init()</code> method merges our new options into the <code>settings</code> variable and overrides the ones used by the first initialization.</p>
<p>In otherwords, we can currently only run one instance of the plugin a time. Let’s fix that.</p>
<h3 id="instantiating-our-script">Instantiating our script</h3>
<p>We’re going to change the way our script works. Instead of initializing the plugin like this:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">accordion</span>.<span class="at">init</span>()<span class="op">;</span></code></pre></div>
<p>Developers will do this:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> <span class="kw">new</span> <span class="at">Accordion</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span></code></pre></div>
<p>This creates an entirely new instance of the plugin, with its own settings and options. It’s commonly called <em>instantiating</em> a plugin.</p>
<p>To make this work, we need to make one major change inside our plugin (and a few smaller ones).</p>
<h3 id="building-a-constructor">Building a Constructor</h3>
<p>Right now, our plugin returns an object with all of our public APIs.</p>
<p>We’re going to move all of the variables and methods that are unique to each instance of our plugin into a function called a constructor. The constructor will return the object of APIs, and our plugin will return the constructor.</p>
<p>JavaScript convention is to capitalize the names of functions that are initialized this way, so we’ll also rename our plugin from <code>accordion</code> to <code>Accordion</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> Accordion <span class="op">=</span> (<span class="kw">function</span> (options) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Shared variables and utility methods...</span>

    <span class="co">// Our plugin constructor</span>
    <span class="co">// Can be named anything you want</span>
    <span class="kw">var</span> BuildAccordion <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

        <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

        <span class="co">// Unique variables and methods</span>

        <span class="co">// Initialize the plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span>(options)<span class="op">;</span>

        <span class="co">// Return the public APIs</span>
        <span class="cf">return</span> publicAPIs<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return the constructor</span>
    <span class="cf">return</span> BuildAccordion<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<p>Common convention with this approach is often (but not always) to pass in the selector as a standalone argument instead of as part of the <code>options</code>. This is in part because you may be instantiating several instances of the plugin, each with their own selector.</p>
<p>With that in mind, our plugin will look something like this.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> Accordion <span class="op">=</span> (<span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Shared variables and utility methods...</span>

    <span class="co">// Our plugin constructor</span>
    <span class="co">// Can be named anything you want</span>
    <span class="kw">var</span> BuildAccordion <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

        <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

        <span class="co">// Unique variables and methods</span>

        <span class="co">// Initialize the plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span>(options)<span class="op">;</span>

        <span class="co">// Return the public APIs</span>
        <span class="cf">return</span> publicAPIs<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return the constructor</span>
    <span class="cf">return</span> BuildAccordion<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h3 id="rewriting-our-accordion-plugin">Rewriting our accordion plugin</h3>
<p>Now, let’s move some stuff around in our accordion plugin to make it work with this approach.</p>
<h4 id="unique-variables-and-methods">Unique variables and methods</h4>
<p>First, let’s pull in any variables and methods that need to be unique to each instance of our plugin. These are are typically variables that hold instance-specific data (like our <code>settings</code> variable) or reference instance-specific data (the <code>isActive()</code> method uses our <code>settings</code> variable internally).</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> Accordion <span class="op">=</span> (<span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Shared variables and utility methods...</span>

    <span class="co">// Our plugin constructor</span>
    <span class="co">// Can be named anything you want</span>
    <span class="kw">var</span> BuildAccordion <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span> <span class="co">// Our public APIs</span>
        <span class="kw">var</span> settings<span class="op">;</span> <span class="co">// Settings</span>

        <span class="co">// Check if the target content is already active</span>
        <span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
            <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)) <span class="op">{</span>
                <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
                <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                    <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                        <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                        <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                            <span class="dt">toggle</span><span class="op">:</span> toggle
                        <span class="op">}</span>
                    <span class="op">}</span>)<span class="op">;</span>
                    <span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                <span class="op">}</span>

                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all items with a matching selector</span>
        <span class="kw">var</span> closeItems <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> activeClass) <span class="op">{</span>
            <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
            <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
                items[i].<span class="va">classList</span>.<span class="at">remove</span>(activeClass)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (selector <span class="op">===</span> <span class="va">settings</span>.<span class="at">selectorContent</span>) <span class="op">{</span>
                    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                        <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                            <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                            <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                                <span class="dt">toggle</span><span class="op">:</span> <span class="kw">null</span>
                            <span class="op">}</span>
                        <span class="op">}</span>)<span class="op">;</span>
                        items[i].<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all accordions and toggles</span>
        <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorContent</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Run our accordion script</span>
        <span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if the clicked link was an accordion toggle</span>
            <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="at">matches</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span>)) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Get the target content</span>
            <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Prevent default link behavior</span>
            <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

            <span class="co">// If the content is already expanded, collapse it and quit</span>
            <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
            <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Close all accordion content and toggles</span>
            <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span>()<span class="op">;</span>

            <span class="co">// Open our target content area and toggle link</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>


            <span class="co">// Dispatch a custom event</span>
            <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                <span class="kw">var</span> customEvent <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
                    <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                    <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                        <span class="dt">toggle</span><span class="op">:</span> <span class="va">event</span>.<span class="at">target</span>
                    <span class="op">}</span>
                <span class="op">}</span>)<span class="op">;</span>
                <span class="va">content</span>.<span class="at">dispatchEvent</span>(customEvent)<span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if settings is set</span>
            <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Remove event listener</span>
            <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Remove the initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">init</span>)<span class="op">;</span>

            <span class="co">// Reset settings</span>
            settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize our plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>
            <span class="co">// Feature test</span>
            <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Destroy any previous initializations</span>
            <span class="va">publicAPIs</span>.<span class="at">destroy</span>()<span class="op">;</span>

            <span class="co">// Merge user options with the defaults</span>
            settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

            <span class="co">// Listen for click events</span>
            <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Add our initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">init</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize the plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span>(options)<span class="op">;</span>

        <span class="co">// Return the public APIs</span>
        <span class="cf">return</span> publicAPIs<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return the constructor</span>
    <span class="cf">return</span> BuildAccordion<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h4 id="shared-variables-and-methods">Shared variables and methods</h4>
<p>Variables and methods that don’t contain any instance-specific data can and should stay outside of the constructor to reduce the amount of memory is used each time we create a new one.</p>
<p>This includes our <code>matches()</code> polyfill, the <code>default</code> settings, and the <code>extend()</code> helper method.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> Accordion <span class="op">=</span> (<span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Element.matches() polyfill (simple version)</span>
    <span class="co">// https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Defaults</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="co">// Selectors</span>
        <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
        <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

        <span class="co">// Classes</span>
        <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
    <span class="op">};</span>

    <span class="co">/*!</span>
<span class="co">     * Merge two or more objects together.</span>
<span class="co">     * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Boolean}</span><span class="co">  deep     If true, do a deep (or recursive) merge [optional]</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Object}</span><span class="co">   objects  The objects to merge together</span>
<span class="co">     * </span><span class="kw">@returns</span><span class="co"> {Object}            Merged values of defaults and options</span>
<span class="co">     */</span>
    <span class="kw">var</span> extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> extended <span class="op">=</span> <span class="op">{};</span>
        <span class="kw">var</span> deep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
        <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>

        <span class="co">// Check if a deep merge</span>
        <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>( arguments[<span class="dv">0</span>] ) <span class="op">===</span> <span class="st">&#39;[object Boolean]&#39;</span> ) <span class="op">{</span>
            deep <span class="op">=</span> arguments[<span class="dv">0</span>]<span class="op">;</span>
            i<span class="op">++;</span>
        <span class="op">}</span>

        <span class="co">// Merge the object into the extended object</span>
        <span class="kw">var</span> merge <span class="op">=</span> <span class="kw">function</span> (obj) <span class="op">{</span>
            <span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> obj) <span class="op">{</span>
                <span class="cf">if</span> (<span class="va">obj</span>.<span class="at">hasOwnProperty</span>(prop)) <span class="op">{</span>
                    <span class="co">// If property is an object, merge properties</span>
                    <span class="cf">if</span> (deep <span class="op">&amp;&amp;</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(obj[prop]) <span class="op">===</span> <span class="st">&#39;[object Object]&#39;</span>) <span class="op">{</span>
                        extended[prop] <span class="op">=</span> <span class="at">extend</span>(extended[prop]<span class="op">,</span> obj[prop])<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        extended[prop] <span class="op">=</span> obj[prop]<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Loop through each object and conduct a merge</span>
        <span class="cf">for</span> (<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">arguments</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            <span class="kw">var</span> obj <span class="op">=</span> arguments[i]<span class="op">;</span>
            <span class="at">merge</span>(obj)<span class="op">;</span>
        <span class="op">}</span>

        <span class="cf">return</span> extended<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Our plugin constructor</span>
    <span class="co">// Can be named anything you want</span>
    <span class="kw">var</span> BuildAccordion <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span> <span class="co">// Our public APIs</span>
        <span class="kw">var</span> settings<span class="op">;</span> <span class="co">// Settings</span>

        <span class="co">// Check if the target content is already active</span>
        <span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
            <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)) <span class="op">{</span>
                <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
                <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                    <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                        <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                        <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                            <span class="dt">toggle</span><span class="op">:</span> toggle
                        <span class="op">}</span>
                    <span class="op">}</span>)<span class="op">;</span>
                    <span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                <span class="op">}</span>

                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all items with a matching selector</span>
        <span class="kw">var</span> closeItems <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> activeClass) <span class="op">{</span>
            <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
            <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
                items[i].<span class="va">classList</span>.<span class="at">remove</span>(activeClass)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (selector <span class="op">===</span> <span class="va">settings</span>.<span class="at">selectorContent</span>) <span class="op">{</span>
                    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                        <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                            <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                            <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                                <span class="dt">toggle</span><span class="op">:</span> <span class="kw">null</span>
                            <span class="op">}</span>
                        <span class="op">}</span>)<span class="op">;</span>
                        items[i].<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all accordions and toggles</span>
        <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorContent</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Run our accordion script</span>
        <span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if the clicked link was an accordion toggle</span>
            <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="at">matches</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span>)) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Get the target content</span>
            <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Prevent default link behavior</span>
            <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

            <span class="co">// If the content is already expanded, collapse it and quit</span>
            <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
            <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Close all accordion content and toggles</span>
            <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span>()<span class="op">;</span>

            <span class="co">// Open our target content area and toggle link</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>


            <span class="co">// Dispatch a custom event</span>
            <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                <span class="kw">var</span> customEvent <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
                    <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                    <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                        <span class="dt">toggle</span><span class="op">:</span> <span class="va">event</span>.<span class="at">target</span>
                    <span class="op">}</span>
                <span class="op">}</span>)<span class="op">;</span>
                <span class="va">content</span>.<span class="at">dispatchEvent</span>(customEvent)<span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if settings is set</span>
            <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Remove event listener</span>
            <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Remove the initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">init</span>)<span class="op">;</span>

            <span class="co">// Reset settings</span>
            settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize our plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>
            <span class="co">// Feature test</span>
            <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Destroy any previous initializations</span>
            <span class="va">publicAPIs</span>.<span class="at">destroy</span>()<span class="op">;</span>

            <span class="co">// Merge user options with the defaults</span>
            settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

            <span class="co">// Listen for click events</span>
            <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Add our initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">init</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize the plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span>(options)<span class="op">;</span>

        <span class="co">// Return the public APIs</span>
        <span class="cf">return</span> publicAPIs<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return the constructor</span>
    <span class="cf">return</span> BuildAccordion<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h4 id="updating-the-selector">Updating the selector</h4>
<p>Finally, we should change all references to <code>settings.selectorToggle</code> to <code>selector</code> to account for our new approach. We can also remove that option from our <code>defaults</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> Accordion <span class="op">=</span> (<span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Element.matches() polyfill (simple version)</span>
    <span class="co">// https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Defaults</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="co">// Selectors</span>
        <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

        <span class="co">// Classes</span>
        <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
    <span class="op">};</span>

    <span class="co">/*!</span>
<span class="co">     * Merge two or more objects together.</span>
<span class="co">     * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Boolean}</span><span class="co">  deep     If true, do a deep (or recursive) merge [optional]</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Object}</span><span class="co">   objects  The objects to merge together</span>
<span class="co">     * </span><span class="kw">@returns</span><span class="co"> {Object}            Merged values of defaults and options</span>
<span class="co">     */</span>
    <span class="kw">var</span> extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> extended <span class="op">=</span> <span class="op">{};</span>
        <span class="kw">var</span> deep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
        <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>

        <span class="co">// Check if a deep merge</span>
        <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>( arguments[<span class="dv">0</span>] ) <span class="op">===</span> <span class="st">&#39;[object Boolean]&#39;</span> ) <span class="op">{</span>
            deep <span class="op">=</span> arguments[<span class="dv">0</span>]<span class="op">;</span>
            i<span class="op">++;</span>
        <span class="op">}</span>

        <span class="co">// Merge the object into the extended object</span>
        <span class="kw">var</span> merge <span class="op">=</span> <span class="kw">function</span> (obj) <span class="op">{</span>
            <span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> obj) <span class="op">{</span>
                <span class="cf">if</span> (<span class="va">obj</span>.<span class="at">hasOwnProperty</span>(prop)) <span class="op">{</span>
                    <span class="co">// If property is an object, merge properties</span>
                    <span class="cf">if</span> (deep <span class="op">&amp;&amp;</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(obj[prop]) <span class="op">===</span> <span class="st">&#39;[object Object]&#39;</span>) <span class="op">{</span>
                        extended[prop] <span class="op">=</span> <span class="at">extend</span>(extended[prop]<span class="op">,</span> obj[prop])<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        extended[prop] <span class="op">=</span> obj[prop]<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Loop through each object and conduct a merge</span>
        <span class="cf">for</span> (<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">arguments</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            <span class="kw">var</span> obj <span class="op">=</span> arguments[i]<span class="op">;</span>
            <span class="at">merge</span>(obj)<span class="op">;</span>
        <span class="op">}</span>

        <span class="cf">return</span> extended<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Our plugin constructor</span>
    <span class="co">// Can be named anything you want</span>
    <span class="kw">var</span> BuildAccordion <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span> <span class="co">// Our public APIs</span>
        <span class="kw">var</span> settings<span class="op">;</span> <span class="co">// Settings</span>

        <span class="co">// Check if the target content is already active</span>
        <span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
            <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)) <span class="op">{</span>
                <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
                <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                    <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                        <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                        <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                            <span class="dt">toggle</span><span class="op">:</span> toggle
                        <span class="op">}</span>
                    <span class="op">}</span>)<span class="op">;</span>
                    <span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                <span class="op">}</span>

                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all items with a matching selector</span>
        <span class="kw">var</span> closeItems <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> activeClass) <span class="op">{</span>
            <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
            <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
                items[i].<span class="va">classList</span>.<span class="at">remove</span>(activeClass)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (selector <span class="op">===</span> <span class="va">settings</span>.<span class="at">selectorContent</span>) <span class="op">{</span>
                    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                        <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                            <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                            <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                                <span class="dt">toggle</span><span class="op">:</span> <span class="kw">null</span>
                            <span class="op">}</span>
                        <span class="op">}</span>)<span class="op">;</span>
                        items[i].<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all accordions and toggles</span>
        <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorContent</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="at">closeItems</span>(selector<span class="op">,</span> <span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Run our accordion script</span>
        <span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if the clicked link was an accordion toggle</span>
            <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="at">matches</span>(selector)) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Get the target content</span>
            <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Prevent default link behavior</span>
            <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

            <span class="co">// If the content is already expanded, collapse it and quit</span>
            <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
            <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Close all accordion content and toggles</span>
            <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span>()<span class="op">;</span>

            <span class="co">// Open our target content area and toggle link</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>


            <span class="co">// Dispatch a custom event</span>
            <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                <span class="kw">var</span> customEvent <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
                    <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                    <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                        <span class="dt">toggle</span><span class="op">:</span> <span class="va">event</span>.<span class="at">target</span>
                    <span class="op">}</span>
                <span class="op">}</span>)<span class="op">;</span>
                <span class="va">content</span>.<span class="at">dispatchEvent</span>(customEvent)<span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if settings is set</span>
            <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Remove event listener</span>
            <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Remove the initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">init</span>)<span class="op">;</span>

            <span class="co">// Reset settings</span>
            settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize our plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>
            <span class="co">// Feature test</span>
            <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Destroy any previous initializations</span>
            <span class="va">publicAPIs</span>.<span class="at">destroy</span>()<span class="op">;</span>

            <span class="co">// Merge user options with the defaults</span>
            settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

            <span class="co">// Listen for click events</span>
            <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Add our initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">init</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize the plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span>(options)<span class="op">;</span>


        <span class="co">// Return the public APIs</span>
        <span class="cf">return</span> publicAPIs<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return the constructor</span>
    <span class="cf">return</span> BuildAccordion<span class="op">;</span>

<span class="op">}</span>)()<span class="op">;</span></code></pre></div>
<h3 id="when-to-use-constructors">When to use constructors</h3>
<p>This approach is a little bit more complicated than previous versions of our plugin.</p>
<p>If a plugin only needs to be (or only can be) initialized once on a page, use the simple plugin structure. Otherwise, use a constructor, as it provides a lot more flexibility for developers.</p>
<h2 id="universal-module-definition-umd">Universal Module Definition (UMD)</h2>
<p>If you want your plugin to work with RequireJS, Node, WebPack, Browserify, and other module bundlers, you need wrap your code in something called a Universal Module Definition (UMD) pattern.</p>
<p>UMD merges two differing approaches to modules—AMD and CommonJS—with the global variable technique we’ve been using up to this point.</p>
<p>In the boiilerplate below, replace the <code>myPlugin</code> part of <code>root.myPlugin</code> with the name of the global variable you want to use (for example, <code>root.Accordion</code>).</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">(<span class="kw">function</span> (root<span class="op">,</span> factory) <span class="op">{</span>
    <span class="cf">if</span> ( <span class="kw">typeof</span> define <span class="op">===</span> <span class="st">&#39;function&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">define</span>.<span class="at">amd</span> ) <span class="op">{</span>
        <span class="at">define</span>([]<span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="cf">return</span> <span class="at">factory</span>(root)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> ( <span class="kw">typeof</span> exports <span class="op">===</span> <span class="st">&#39;object&#39;</span> ) <span class="op">{</span>
        <span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
        <span class="va">root</span>.<span class="at">myPlugin</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span>
<span class="op">}</span>)(<span class="kw">typeof</span> global <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> global : <span class="kw">typeof</span> window <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> window : <span class="kw">this</span><span class="op">,</span> <span class="kw">function</span> (window) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Your code...</span>

<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<h3 id="the-accordion-plugin-as-umd">The accordion plugin as UMD</h3>
<p>For example, if we converted the constructor version of our plugin to UMD, it would look like this.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">(<span class="kw">function</span> (root<span class="op">,</span> factory) <span class="op">{</span>
    <span class="cf">if</span> ( <span class="kw">typeof</span> define <span class="op">===</span> <span class="st">&#39;function&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">define</span>.<span class="at">amd</span> ) <span class="op">{</span>
        <span class="at">define</span>([]<span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="cf">return</span> <span class="at">factory</span>(root)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> ( <span class="kw">typeof</span> exports <span class="op">===</span> <span class="st">&#39;object&#39;</span> ) <span class="op">{</span>
        <span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
        <span class="va">root</span>.<span class="at">Accordion</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span>
<span class="op">}</span>)(<span class="kw">typeof</span> global <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> global : <span class="kw">typeof</span> window <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> window : <span class="kw">this</span><span class="op">,</span> <span class="kw">function</span> (window) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Element.matches() polyfill (simple version)</span>
    <span class="co">// https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Defaults</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="co">// Selectors</span>
        <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion&#39;</span><span class="op">,</span>

        <span class="co">// Classes</span>
        <span class="dt">toggleClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">contentClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
        <span class="dt">init</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
    <span class="op">};</span>

    <span class="co">/*!</span>
<span class="co">     * Merge two or more objects together.</span>
<span class="co">     * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Boolean}</span><span class="co">  deep     If true, do a deep (or recursive) merge [optional]</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Object}</span><span class="co">   objects  The objects to merge together</span>
<span class="co">     * </span><span class="kw">@returns</span><span class="co"> {Object}            Merged values of defaults and options</span>
<span class="co">     */</span>
    <span class="kw">var</span> extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> extended <span class="op">=</span> <span class="op">{};</span>
        <span class="kw">var</span> deep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
        <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>

        <span class="co">// Check if a deep merge</span>
        <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>( arguments[<span class="dv">0</span>] ) <span class="op">===</span> <span class="st">&#39;[object Boolean]&#39;</span> ) <span class="op">{</span>
            deep <span class="op">=</span> arguments[<span class="dv">0</span>]<span class="op">;</span>
            i<span class="op">++;</span>
        <span class="op">}</span>

        <span class="co">// Merge the object into the extended object</span>
        <span class="kw">var</span> merge <span class="op">=</span> <span class="kw">function</span> (obj) <span class="op">{</span>
            <span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> obj) <span class="op">{</span>
                <span class="cf">if</span> (<span class="va">obj</span>.<span class="at">hasOwnProperty</span>(prop)) <span class="op">{</span>
                    <span class="co">// If property is an object, merge properties</span>
                    <span class="cf">if</span> (deep <span class="op">&amp;&amp;</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(obj[prop]) <span class="op">===</span> <span class="st">&#39;[object Object]&#39;</span>) <span class="op">{</span>
                        extended[prop] <span class="op">=</span> <span class="at">extend</span>(extended[prop]<span class="op">,</span> obj[prop])<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        extended[prop] <span class="op">=</span> obj[prop]<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Loop through each object and conduct a merge</span>
        <span class="cf">for</span> (<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">arguments</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            <span class="kw">var</span> obj <span class="op">=</span> arguments[i]<span class="op">;</span>
            <span class="at">merge</span>(obj)<span class="op">;</span>
        <span class="op">}</span>

        <span class="cf">return</span> extended<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Our plugin constructor</span>
    <span class="co">// Can be named anything you want</span>
    <span class="kw">var</span> BuildAccordion <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span> <span class="co">// Our public APIs</span>
        <span class="kw">var</span> settings<span class="op">;</span> <span class="co">// Settings</span>

        <span class="co">// Check if the target content is already active</span>
        <span class="kw">var</span> isActive <span class="op">=</span> <span class="kw">function</span> (content<span class="op">,</span> toggle) <span class="op">{</span>
            <span class="cf">if</span> (<span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)) <span class="op">{</span>
                <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
                <span class="va">toggle</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                    <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                        <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                        <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                            <span class="dt">toggle</span><span class="op">:</span> toggle
                        <span class="op">}</span>
                    <span class="op">}</span>)<span class="op">;</span>
                    <span class="va">content</span>.<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                <span class="op">}</span>

                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all items with a matching selector</span>
        <span class="kw">var</span> closeItems <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> activeClass) <span class="op">{</span>
            <span class="kw">var</span> items <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(selector)<span class="op">;</span>
            <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">items</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
                items[i].<span class="va">classList</span>.<span class="at">remove</span>(activeClass)<span class="op">;</span>

                <span class="co">// Dispatch a custom event</span>
                <span class="cf">if</span> (selector <span class="op">===</span> <span class="va">settings</span>.<span class="at">selectorContent</span>) <span class="op">{</span>
                    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                        <span class="kw">var</span> event <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionClose&#39;</span><span class="op">,</span> <span class="op">{</span>
                            <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                            <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                                <span class="dt">toggle</span><span class="op">:</span> <span class="kw">null</span>
                            <span class="op">}</span>
                        <span class="op">}</span>)<span class="op">;</span>
                        items[i].<span class="at">dispatchEvent</span>(event)<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Close all accordions and toggles</span>
        <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="at">closeItems</span>(<span class="va">settings</span>.<span class="at">selectorContent</span><span class="op">,</span> <span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="at">closeItems</span>(selector<span class="op">,</span> <span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Run our accordion script</span>
        <span class="kw">var</span> runAccordion <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if the clicked link was an accordion toggle</span>
            <span class="cf">if</span> (<span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="at">matches</span>(selector)) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Get the target content</span>
            <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Prevent default link behavior</span>
            <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

            <span class="co">// If the content is already expanded, collapse it and quit</span>
            <span class="kw">var</span> expanded <span class="op">=</span> <span class="at">isActive</span>(content<span class="op">,</span> <span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
            <span class="cf">if</span> (expanded) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Close all accordion content and toggles</span>
            <span class="va">publicAPIs</span>.<span class="at">closeAccordions</span>()<span class="op">;</span>

            <span class="co">// Open our target content area and toggle link</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">contentClass</span>)<span class="op">;</span>
            <span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">toggleClass</span>)<span class="op">;</span>


            <span class="co">// Dispatch a custom event</span>
            <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                <span class="kw">var</span> customEvent <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;accordionOpen&#39;</span><span class="op">,</span> <span class="op">{</span>
                    <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                    <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                        <span class="dt">toggle</span><span class="op">:</span> <span class="va">event</span>.<span class="at">target</span>
                    <span class="op">}</span>
                <span class="op">}</span>)<span class="op">;</span>
                <span class="va">content</span>.<span class="at">dispatchEvent</span>(customEvent)<span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="co">// Only run if settings is set</span>
            <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Remove event listener</span>
            <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Remove the initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">init</span>)<span class="op">;</span>

            <span class="co">// Reset settings</span>
            settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize our plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>
            <span class="co">// Feature test</span>
            <span class="kw">var</span> supports <span class="op">=</span> <span class="st">&#39;querySelector&#39;</span> <span class="kw">in</span> document <span class="op">&amp;&amp;</span> <span class="st">&#39;addEventListener&#39;</span> <span class="kw">in</span> window<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>supports) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Destroy any previous initializations</span>
            <span class="va">publicAPIs</span>.<span class="at">destroy</span>()<span class="op">;</span>

            <span class="co">// Merge user options with the defaults</span>
            settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

            <span class="co">// Listen for click events</span>
            <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> runAccordion<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Add our initialization class</span>
            <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">init</span><span class="op">;</span>
        <span class="op">};</span>

        <span class="co">// Initialize the plugin</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span>(options)<span class="op">;</span>


        <span class="co">// Return the public APIs</span>
        <span class="cf">return</span> publicAPIs<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return the constructor</span>
    <span class="cf">return</span> BuildAccordion<span class="op">;</span>

<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>You would instantiate it just like before.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> accordion <span class="op">=</span> <span class="kw">new</span> <span class="at">Accordion</span>(<span class="st">&#39;.accordion-toggle&#39;</span>)<span class="op">;</span></code></pre></div>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>To make this all tangible, let’s work on a project together. We’ll take a script that mirrors content from a textarea or input field into a preview window and convert it into a plugin.</p>
<p>The starter template and complete project code are included in the source code<a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a> on GitHub.</p>
<h3 id="getting-setup">Getting Setup</h3>
<p>The starter template includes a small amount of CSS to make the layout look nicer, but none of it is neccessary for the script to work.</p>
<p>The script listens for <code>keyup</code> and <code>paste</code> events that happen inside fields that have the <code>.mirror</code> class. It uses the <code>[data-mirror]</code> attribute to get the selector of the container to mirror the content in, and updates that container’s <code>innerHTML</code>.</p>
<h4 id="markup">Markup</h4>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;textarea</span><span class="ot"> class=</span><span class="st">&quot;mirror&quot;</span><span class="ot"> data-mirror=</span><span class="st">&quot;#content&quot;</span><span class="kw">&gt;&lt;/textarea&gt;</span>
<span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;content&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></code></pre></div>
<h4 id="javascript">JavaScript</h4>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Element.matches() polyfill (simple version)</span>
<span class="co"> * https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
<span class="co"> */</span>
<span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
    <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
<span class="op">}</span>

<span class="co">// Setup our change events</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
    <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(<span class="st">&#39;.mirror&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the container to mirror our content into</span>
    <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="st">&#39;data-mirror&#39;</span>))<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Copy our field content into the container</span>
    <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

<span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span>

<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
    <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(<span class="st">&#39;.mirror&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the container to mirror our content into</span>
    <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="st">&#39;data-mirror&#39;</span>))<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
    <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Copy our field content into the container</span>
        <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

    <span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span>

<span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<h3 id="planning">Planning</h3>
<p>Let’s put together a quick plan for what we’d like to do.</p>
<ol style="list-style-type: decimal">
<li>Modularize our script.</li>
<li>Scope our code inside a function wrapper.</li>
<li>Add an initialization function.</li>
<li>Let users pass in options to configure things.</li>
<li>Create a public method to mirror content.</li>
<li>Add some custom events developers can hook into.</li>
<li>Add a destroy function.</li>
<li>Allow multiple instances of the plugin to run at once.</li>
</ol>
<h3 id="modularize-the-code">Modularize the code</h3>
<p>The first thing we want to do is modularize our code.</p>
<p>Currently, we have two event listeners that do more or less the same thing. The only difference is that our <code>paste</code> event adds a 1ms timeout before duplicating the input value (neccessary because the <code>paste</code> event fires <em>before</em> content is pasted, oddly). A 1ms delay is imperceivable, so there’s no reason we can’t use that with our <code>keyup</code> events, too.</p>
<p>Let’s move that code to a new function called <code>changeHandler()</code>, and call that in our event listeners.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Handle changes to our inputs and textareas</span>
<span class="co"> */</span>
<span class="kw">var</span> changeHandler <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
    <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(<span class="st">&#39;.mirror&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the container to mirror our content into</span>
    <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="st">&#39;data-mirror&#39;</span>))<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
    <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Copy our field content into the container</span>
        <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

    <span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span>

<span class="op">};</span>

<span class="co">// Detect changes to our fields</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<h3 id="scoping-our-code-1">Scoping our code</h3>
<p>Next, let’s add a functional wrapper around our code to keep it out of the global scope.</p>
<p>To maximize compatibility with module loaders, let’s use a UMD wrapper. We’ll paste our current code into the boilerplate, and change <code>root.myPlugin</code> to <code>root.Mirror</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*!</span>
<span class="co"> * Universal Module Definition (UMD) Boilerplate</span>
<span class="co"> * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co"> */</span>
 (<span class="kw">function</span> (root<span class="op">,</span> factory) <span class="op">{</span>
    <span class="cf">if</span> ( <span class="kw">typeof</span> define <span class="op">===</span> <span class="st">&#39;function&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">define</span>.<span class="at">amd</span> ) <span class="op">{</span>
        <span class="at">define</span>([]<span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="cf">return</span> <span class="at">factory</span>(root)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> ( <span class="kw">typeof</span> exports <span class="op">===</span> <span class="st">&#39;object&#39;</span> ) <span class="op">{</span>
        <span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
        <span class="va">root</span>.<span class="at">Mirror</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span>
 <span class="op">}</span>)(<span class="kw">typeof</span> global <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> global : <span class="kw">typeof</span> window <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> window : <span class="kw">this</span><span class="op">,</span> <span class="kw">function</span> (window) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">/**</span>
<span class="co">     * Element.matches() polyfill (simple version)</span>
<span class="co">     * https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
<span class="co">     */</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">/**</span>
<span class="co">     * Handle changes to our inputs and textareas</span>
<span class="co">     */</span>
    <span class="kw">var</span> changeHandler <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
        <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(<span class="st">&#39;.mirror&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the container to mirror our content into</span>
        <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="st">&#39;data-mirror&#39;</span>))<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
        <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>

            <span class="co">// Copy our field content into the container</span>
            <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

        <span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Detect changes to our fields</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<h3 id="add-an-initialization-method">Add an initialization method</h3>
<p>Now, let’s add an initialization function, so that it only runs if we explicitly call it.</p>
<p>We’ll add a placeholder object for our public methods, move our event listeners to an <code>.init()</code> method, and return our public methods object.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*!</span>
<span class="co"> * Universal Module Definition (UMD) Boilerplate</span>
<span class="co"> * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co"> */</span>
(<span class="kw">function</span> (root<span class="op">,</span> factory) <span class="op">{</span>
    <span class="cf">if</span> ( <span class="kw">typeof</span> define <span class="op">===</span> <span class="st">&#39;function&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">define</span>.<span class="at">amd</span> ) <span class="op">{</span>
        <span class="at">define</span>([]<span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="cf">return</span> <span class="at">factory</span>(root)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> ( <span class="kw">typeof</span> exports <span class="op">===</span> <span class="st">&#39;object&#39;</span> ) <span class="op">{</span>
        <span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
        <span class="va">root</span>.<span class="at">Mirror</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span>
 <span class="op">}</span>)(<span class="kw">typeof</span> global <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> global : <span class="kw">typeof</span> window <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> window : <span class="kw">this</span><span class="op">,</span> <span class="kw">function</span> (window) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">/**</span>
<span class="co">     * Element.matches() polyfill (simple version)</span>
<span class="co">     * https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
<span class="co">     */</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
    <span class="op">}</span>


    <span class="co">// Hold our public methods</span>
    <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

    <span class="co">/**</span>
<span class="co">     * Handle changes to our inputs and textareas</span>
<span class="co">     */</span>
    <span class="kw">var</span> changeHandler <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
        <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(<span class="st">&#39;.mirror&#39;</span>)) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the container to mirror our content into</span>
        <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="st">&#39;data-mirror&#39;</span>))<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
        <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>

            <span class="co">// Copy our field content into the container</span>
            <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

        <span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">/**</span>
<span class="co">     * Initialize the plugin</span>
<span class="co">     */</span>
    <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Detect changes to our fields</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// Return our public methods</span>
    <span class="cf">return</span> publicAPIs<span class="op">;</span>

<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>Now we need to initialize our script.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Initialize the plugin</span>
<span class="va">Mirror</span>.<span class="at">init</span>()<span class="op">;</span></code></pre></div>
<h3 id="add-user-options">Add user options</h3>
<p>Next, let’s add some options that users can configure themselves.</p>
<p>To get started, let’s set up our defaults as an object with key/value pairs, and add a <code>null</code> variable to hold our settings globally within our plugin. We’ll include options to change the selector, and the data attribute that holds our content selector.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Default settings</span>
<span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
    <span class="dt">selector</span><span class="op">:</span> <span class="st">&#39;.mirror&#39;</span><span class="op">,</span>
    <span class="dt">content</span><span class="op">:</span> <span class="st">&#39;[data-mirror]&#39;</span>
<span class="op">};</span></code></pre></div>
<p>Next, we’ll create a variable called <code>settings</code> that will hold our plugin settings. Then, we’ll add the <code>extend()</code> helper method<a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Default settings</span>
<span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
    <span class="dt">selector</span><span class="op">:</span> <span class="st">&#39;.mirror&#39;</span><span class="op">,</span>
    <span class="dt">content</span><span class="op">:</span> <span class="st">&#39;data-mirror&#39;</span>
<span class="op">};</span>

<span class="co">// Define settings variable</span>
<span class="kw">var</span> settings<span class="op">;</span>

<span class="co">/*!</span>
<span class="co"> * Merge two or more objects together.</span>
<span class="co"> * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Boolean}</span><span class="co">  deep     If true, do a deep (or recursive) merge [optional]</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Object}</span><span class="co">   objects  The objects to merge together</span>
<span class="co"> * </span><span class="kw">@returns</span><span class="co"> {Object}            Merged values of defaults and options</span>
<span class="co"> */</span>
<span class="kw">var</span> extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>
    <span class="co">// ...</span>
<span class="op">};</span></code></pre></div>
<p>In our <code>init()</code> method, we’ll pass <code>options</code> in as an argument, and merge them into <code>defaults</code> to create our <code>settings</code> object.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Initialize the plugin</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Object}</span><span class="co"> options User options</span>
<span class="co"> */</span>
<span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

    <span class="co">// Merge user options into defaults</span>
    settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

    <span class="co">// Detect changes to our fields</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>And finally, we’ll change any references to <code>.mirror</code> and <code>[data-mirror]</code> to our settings values in the <code>changeHandler()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Handle changes to our inputs and textareas</span>
<span class="co"> */</span>
<span class="kw">var</span> changeHandler <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
    <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(<span class="va">settings</span>.<span class="at">selector</span>)) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the container to mirror our content into</span>
    <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="va">settings</span>.<span class="at">content</span>))<span class="op">;</span>
    <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
    <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Copy our field content into the container</span>
        <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

    <span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<h3 id="create-a-public-method-to-save-content">Create a public method to save content</h3>
<p>To give this plugin even more flexibility, let’s provide a public method for mirroring content.</p>
<p>Developers can call it from their own scripts and cause content to mirror even if a <code>keyup</code> or <code>paste</code> event hasn’t happened (useful if setting an input value with JavaScript).</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Copy our field content into the container</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Node}</span><span class="co"> mirror The field to mirror</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Node}</span><span class="co"> target The field to mirror content into</span>
<span class="co"> */</span>
<span class="va">publicAPIs</span>.<span class="at">mirror</span> <span class="op">=</span> <span class="kw">function</span> (mirror<span class="op">,</span> target) <span class="op">{</span>
    <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>
<span class="op">};</span></code></pre></div>
<p>We’ll call our new public <code>mirror()</code> method from our <code>setTimeout()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
<span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>
    <span class="va">publicAPIs</span>.<span class="at">mirror</span>(mirror<span class="op">,</span> target)<span class="op">;</span>
<span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span></code></pre></div>
<h3 id="add-custom-events">Add custom events</h3>
<p>Now let’s add custom events to our plugin.</p>
<p>A developer may want to, for example, save data to <code>localStorage</code> or to a database via an API when a field changes. Custom events will give them a hook to do that.</p>
<p>First, we’ll add the CustomEvents polyfill<a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a> to our script.</p>
<p>Then, in the <code>mirror()</code> method, we’ll add a <code>mirrored</code> event. We’ll apply the event to our field, set <code>bubbles</code> to <code>true</code>, and pass in the content area as a <code>detail</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Copy our field content into the container</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Node}</span><span class="co"> mirror The field to mirror</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Node}</span><span class="co"> target The field to mirror content into</span>
<span class="co"> */</span>
<span class="va">publicAPIs</span>.<span class="at">mirror</span> <span class="op">=</span> <span class="kw">function</span> (mirror<span class="op">,</span> target) <span class="op">{</span>
    <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

    <span class="co">// Dispatch a custom event</span>
    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
        <span class="kw">var</span> customEvent <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;mirrored&#39;</span><span class="op">,</span> <span class="op">{</span>
            <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
            <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                <span class="dt">content</span><span class="op">:</span> target
            <span class="op">}</span>
        <span class="op">}</span>)<span class="op">;</span>
        <span class="va">mirror</span>.<span class="at">dispatchEvent</span>(customEvent)<span class="op">;</span>
    <span class="op">}</span>
<span class="op">};</span></code></pre></div>
<p>To test this, let’s set up a <code>mirrored</code> event listener, and log both <code>event.target</code> (the mirrored field) and <code>event.detail.content</code> (the content area) into the console.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Initialize the plugin</span>
<span class="va">Mirror</span>.<span class="at">init</span>()<span class="op">;</span>

<span class="co">// Listen for `mirrored` events</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;mirrored&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="va">event</span>.<span class="at">target</span>)<span class="op">;</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="va">event</span>.<span class="va">detail</span>.<span class="at">content</span>)<span class="op">;</span>
<span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<h3 id="add-a-destroy-function">Add a destroy function</h3>
<p>Now we can add a function to destroy our initialization. We’ll remove our event listeners, and wipe our any mirrored fields.</p>
<p>This will be a public method, and we’ll call it in our initialization method.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Destroy initialization</span>
<span class="co"> */</span>
<span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Only run if settings exist</span>
    <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Remove event listeners</span>
    <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
    <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Reset any mirrored content</span>
    <span class="kw">var</span> mirrors <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="va">settings</span>.<span class="at">selector</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">mirrors</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(mirrors[i].<span class="at">getAttribute</span>(<span class="va">settings</span>.<span class="at">content</span>))<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">continue</span><span class="op">;</span>
        <span class="va">content</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Reset settings</span>
    settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Initialize the plugin</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Object}</span><span class="co"> options User options</span>
<span class="co"> */</span>
<span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

    <span class="co">// Destroy any existing initialization</span>
    <span class="va">publicAPIs</span>.<span class="at">destroy</span>()<span class="op">;</span>

    <span class="co">// Merge user options into defaults</span>
    settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

    <span class="co">// Detect changes to our fields</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>If you open up the console tab in developer tools and run <code>Mirror.destroy()</code>, any mirrored content should disappear, and typing into one of our fields won’t do anything.</p>
<h3 id="allow-multiple-instances-of-the-plugin-to-run-at-once">Allow multiple instances of the plugin to run at once</h3>
<p>A developer may want to run multiple instances of the plugin with different settings. Let’s switch to a constructor model to let them do so.</p>
<p>First, let’s add a constructor function named <code>Mirror()</code> to the end of our script, and pass our options into it. Then we’ll return it for external access.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">//</span>
<span class="co">// Constructor</span>
<span class="co">//</span>

<span class="kw">var</span> Mirror <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

<span class="op">};</span>

<span class="co">// Return our constructor</span>
<span class="cf">return</span> Mirror<span class="op">;</span></code></pre></div>
<p>Next, let’s move any unique variables and methods into the constructor. That includes our <code>publicAPIs</code> and <code>settings</code> variables, and our <code>mirror()</code>, <code>changeHandler()</code>, <code>destroy()</code>, and <code>init()</code> methods.</p>
<p>The rest of our variables and helper methods can be shared across instantiations.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/*!</span>
<span class="co"> * Universal Module Definition (UMD) Boilerplate</span>
<span class="co"> * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co"> */</span>
 (<span class="kw">function</span> (root<span class="op">,</span> factory) <span class="op">{</span>
    <span class="cf">if</span> ( <span class="kw">typeof</span> define <span class="op">===</span> <span class="st">&#39;function&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">define</span>.<span class="at">amd</span> ) <span class="op">{</span>
        <span class="at">define</span>([]<span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span>
            <span class="cf">return</span> <span class="at">factory</span>(root)<span class="op">;</span>
        <span class="op">}</span>)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> ( <span class="kw">typeof</span> exports <span class="op">===</span> <span class="st">&#39;object&#39;</span> ) <span class="op">{</span>
        <span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
        <span class="va">root</span>.<span class="at">Mirror</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span>
 <span class="op">}</span>)(<span class="kw">typeof</span> global <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> global : <span class="kw">typeof</span> window <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> window : <span class="kw">this</span><span class="op">,</span> <span class="kw">function</span> (window) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>


    <span class="co">//</span>
    <span class="co">// Polyfills</span>
    <span class="co">//</span>

    <span class="co">/**</span>
<span class="co">     * Element.matches() polyfill (simple version)</span>
<span class="co">     * https://developer.mozilla.org/en-US/docs/Web/API/Element/matches#Polyfill</span>
<span class="co">     */</span>
    <span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span> <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">/**</span>
<span class="co">     * CustomEvent() polyfill</span>
<span class="co">     * https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Polyfill</span>
<span class="co">     */</span>
    (<span class="kw">function</span> () <span class="op">{</span>

        <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&quot;function&quot;</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>

        <span class="kw">function</span> <span class="at">CustomEvent</span>(event<span class="op">,</span> params) <span class="op">{</span>
            params <span class="op">=</span> params <span class="op">||</span> <span class="op">{</span> <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">cancelable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">detail</span><span class="op">:</span> <span class="kw">undefined</span> <span class="op">};</span>
            <span class="kw">var</span> evt <span class="op">=</span> <span class="va">document</span>.<span class="at">createEvent</span>(<span class="st">&#39;CustomEvent&#39;</span>)<span class="op">;</span>
            <span class="va">evt</span>.<span class="at">initCustomEvent</span>(event<span class="op">,</span> <span class="va">params</span>.<span class="at">bubbles</span><span class="op">,</span> <span class="va">params</span>.<span class="at">cancelable</span><span class="op">,</span> <span class="va">params</span>.<span class="at">detail</span>)<span class="op">;</span>
            <span class="cf">return</span> evt<span class="op">;</span>
        <span class="op">}</span>

        <span class="va">CustomEvent</span>.<span class="at">prototype</span> <span class="op">=</span> <span class="va">window</span>.<span class="va">Event</span>.<span class="at">prototype</span><span class="op">;</span>

        <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">=</span> CustomEvent<span class="op">;</span>
    <span class="op">}</span>)()<span class="op">;</span>


    <span class="co">//</span>
    <span class="co">// Shared Variables</span>
    <span class="co">//</span>

    <span class="co">// Default settings</span>
    <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
        <span class="dt">selector</span><span class="op">:</span> <span class="st">&#39;.mirror&#39;</span><span class="op">,</span>
        <span class="dt">content</span><span class="op">:</span> <span class="st">&#39;data-mirror&#39;</span>
    <span class="op">};</span>


    <span class="co">//</span>
    <span class="co">// Shared Methods</span>
    <span class="co">//</span>

    <span class="co">/*!</span>
<span class="co">     * Merge two or more objects together.</span>
<span class="co">     * (c) 2017 Chris Ferdinandi, MIT License, https://gomakethings.com</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Boolean}</span><span class="co">  deep     If true, do a deep (or recursive) merge [optional]</span>
<span class="co">     * </span><span class="kw">@param</span><span class="co">   </span><span class="kw">{Object}</span><span class="co">   objects  The objects to merge together</span>
<span class="co">     * </span><span class="kw">@returns</span><span class="co"> {Object}            Merged values of defaults and options</span>
<span class="co">     */</span>
    <span class="kw">var</span> extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Variables</span>
        <span class="kw">var</span> extended <span class="op">=</span> <span class="op">{};</span>
        <span class="kw">var</span> deep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
        <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>

        <span class="co">// Check if a deep merge</span>
        <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>( arguments[<span class="dv">0</span>] ) <span class="op">===</span> <span class="st">&#39;[object Boolean]&#39;</span> ) <span class="op">{</span>
            deep <span class="op">=</span> arguments[<span class="dv">0</span>]<span class="op">;</span>
            i<span class="op">++;</span>
        <span class="op">}</span>

        <span class="co">// Merge the object into the extended object</span>
        <span class="kw">var</span> merge <span class="op">=</span> <span class="kw">function</span> (obj) <span class="op">{</span>
            <span class="cf">for</span> (<span class="kw">var</span> prop <span class="kw">in</span> obj) <span class="op">{</span>
                <span class="cf">if</span> (<span class="va">obj</span>.<span class="at">hasOwnProperty</span>(prop)) <span class="op">{</span>
                    <span class="co">// If property is an object, merge properties</span>
                    <span class="cf">if</span> (deep <span class="op">&amp;&amp;</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(obj[prop]) <span class="op">===</span> <span class="st">&#39;[object Object]&#39;</span>) <span class="op">{</span>
                        extended[prop] <span class="op">=</span> <span class="at">extend</span>(extended[prop]<span class="op">,</span> obj[prop])<span class="op">;</span>
                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                        extended[prop] <span class="op">=</span> obj[prop]<span class="op">;</span>
                    <span class="op">}</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">// Loop through each object and conduct a merge</span>
        <span class="cf">for</span> (<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">arguments</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            <span class="kw">var</span> obj <span class="op">=</span> arguments[i]<span class="op">;</span>
            <span class="at">merge</span>(obj)<span class="op">;</span>
        <span class="op">}</span>

        <span class="cf">return</span> extended<span class="op">;</span>

    <span class="op">};</span>


    <span class="co">//</span>
    <span class="co">// Constructor</span>
    <span class="co">//</span>

    <span class="kw">var</span> Mirror <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>


        <span class="co">//</span>
        <span class="co">// Unique Variables</span>
        <span class="co">//</span>

        <span class="co">// Hold our public methods</span>
        <span class="kw">var</span> publicAPIs <span class="op">=</span> <span class="op">{};</span>

        <span class="co">// Default settings</span>
        <span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
            <span class="dt">selector</span><span class="op">:</span> <span class="st">&#39;.mirror&#39;</span><span class="op">,</span>
            <span class="dt">content</span><span class="op">:</span> <span class="st">&#39;data-mirror&#39;</span>
        <span class="op">};</span>

        <span class="co">// Define settings variable</span>
        <span class="kw">var</span> settings<span class="op">;</span>


        <span class="co">//</span>
        <span class="co">// Unique Methods</span>
        <span class="co">//</span>

        <span class="co">/**</span>
<span class="co">         * Copy our field content into the container</span>
<span class="co">         * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Node}</span><span class="co"> mirror The field to mirror</span>
<span class="co">         * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Node}</span><span class="co"> target The field to mirror content into</span>
<span class="co">         */</span>
        <span class="va">publicAPIs</span>.<span class="at">mirror</span> <span class="op">=</span> <span class="kw">function</span> (mirror<span class="op">,</span> target) <span class="op">{</span>
            <span class="va">target</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">mirror</span>.<span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&lt;br&gt;&#39;</span>)<span class="op">;</span>

            <span class="co">// Dispatch a custom event</span>
            <span class="cf">if</span> (<span class="kw">typeof</span> <span class="va">window</span>.<span class="at">CustomEvent</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) <span class="op">{</span>
                <span class="kw">var</span> customEvent <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&#39;mirrored&#39;</span><span class="op">,</span> <span class="op">{</span>
                    <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span>
                    <span class="dt">detail</span><span class="op">:</span> <span class="op">{</span>
                        <span class="dt">content</span><span class="op">:</span> target
                    <span class="op">}</span>
                <span class="op">}</span>)<span class="op">;</span>
                <span class="va">mirror</span>.<span class="at">dispatchEvent</span>(customEvent)<span class="op">;</span>
            <span class="op">}</span>
        <span class="op">};</span>

        <span class="co">/**</span>
<span class="co">         * Handle changes to our inputs and textareas</span>
<span class="co">         */</span>
        <span class="kw">var</span> changeHandler <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

            <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
            <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(<span class="va">settings</span>.<span class="at">selector</span>)) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Get the container to mirror our content into</span>
            <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="va">settings</span>.<span class="at">content</span>))<span class="op">;</span>
            <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
            <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>
                <span class="va">publicAPIs</span>.<span class="at">mirror</span>(mirror<span class="op">,</span> target)<span class="op">;</span>
            <span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span>

        <span class="op">};</span>

        <span class="co">/**</span>
<span class="co">         * Destroy initialization</span>
<span class="co">         */</span>
        <span class="va">publicAPIs</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

            <span class="co">// Only run if settings exist</span>
            <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Remove event listeners</span>
            <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
            <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

            <span class="co">// Reset any mirrored content</span>
            <span class="kw">var</span> mirrors <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="va">settings</span>.<span class="at">selector</span>)<span class="op">;</span>
            <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">mirrors</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
                <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(mirrors[i].<span class="at">getAttribute</span>(<span class="va">settings</span>.<span class="at">content</span>))<span class="op">;</span>
                <span class="cf">if</span> (<span class="op">!</span>content) <span class="cf">continue</span><span class="op">;</span>
                <span class="va">content</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span>
            <span class="op">}</span>

            <span class="co">// Reset settings</span>
            settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

        <span class="op">};</span>

        <span class="co">/**</span>
<span class="co">         * Initialize the plugin</span>
<span class="co">         * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Object}</span><span class="co"> options User options</span>
<span class="co">         */</span>
        <span class="va">publicAPIs</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

            <span class="co">// Destroy any existing initialization</span>
            <span class="va">publicAPIs</span>.<span class="at">destroy</span>()<span class="op">;</span>

            <span class="co">// Merge user options into defaults</span>
            settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

            <span class="co">// Detect changes to our fields</span>
            <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;keyup&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>
            <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;paste&#39;</span><span class="op">,</span> changeHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

        <span class="op">};</span>


        <span class="co">// Return our public methods</span>
        <span class="cf">return</span> publicAPIs<span class="op">;</span>

    <span class="op">};</span>


    <span class="co">// Return our constructor</span>
    <span class="cf">return</span> Mirror<span class="op">;</span>

<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<p>Now, we want to change the way we instantiate our plugin.</p>
<p>We’ll pass our selector directly into the <code>Mirror()</code> function as the first argument, and our <code>options</code> in as the second. We can remove <code>selector</code> from our <code>defaults</code>. We’ll also need to pass it into our constructor, and change references to <code>settings.selector</code> in our script.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Default settings</span>
<span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
    <span class="dt">content</span><span class="op">:</span> <span class="st">&#39;data-mirror&#39;</span>
<span class="op">};</span>

<span class="co">// ...</span>

<span class="co">//</span>
<span class="co">// Constructor</span>
<span class="co">//</span>

<span class="kw">var</span> Mirror <span class="op">=</span> <span class="kw">function</span> (selector<span class="op">,</span> options) <span class="op">{</span>

    <span class="co">// ...</span>

    <span class="co">/**</span>
<span class="co">     * Handle changes to our inputs and textareas</span>
<span class="co">     */</span>
    <span class="kw">var</span> changeHandler <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Check if the keyup/paste event happened in a field we want to mirror</span>
        <span class="kw">var</span> mirror <span class="op">=</span> <span class="va">document</span>.<span class="at">activeElement</span><span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span><span class="va">mirror</span>.<span class="at">matches</span>(selector)) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the container to mirror our content into</span>
        <span class="kw">var</span> target <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">mirror</span>.<span class="at">getAttribute</span>(<span class="va">settings</span>.<span class="at">content</span>))<span class="op">;</span>
        <span class="cf">if</span> (<span class="op">!</span>target) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Set a 1ms timeout to account for paste event happening before text is pasted in</span>
        <span class="va">window</span>.<span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span>
            <span class="va">publicAPIs</span>.<span class="at">mirror</span>(mirror<span class="op">,</span> target)<span class="op">;</span>
        <span class="op">},</span> <span class="dv">1</span>)<span class="op">;</span>

    <span class="op">};</span>

    <span class="co">// ...</span>

<span class="op">}</span></code></pre></div>
<p>Finally, we want to automatically initialize our plugin on instantiation. Let’s call <code>publicAPIs.init()</code> right before returning our public APIs.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Initialize the plugin</span>
<span class="va">publicAPIs</span>.<span class="at">init</span>(options)<span class="op">;</span>

<span class="co">// Return our public methods</span>
<span class="cf">return</span> publicAPIs<span class="op">;</span></code></pre></div>
<p>Now, we can instantiate our plugin.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> mirror <span class="op">=</span> <span class="kw">new</span> <span class="at">Mirror</span>(<span class="st">&#39;.mirror&#39;</span>)<span class="op">;</span></code></pre></div>
<p>And with that, you’ve made a plugin that’s incredibly flexible and developer-friendly. Congrats!</p>
<h2 id="putting-it-all-together-1">Putting it all together</h2>
<p>To make this all tangible, let’s work on a project together. We’ll take a simple accordion script and convert it into a plugin.</p>
<p>The starter template and complete project code are included in the source code<a href="#fn9" class="footnoteRef" id="fnref9"><sup>9</sup></a> on GitHub.</p>
<h3 id="getting-setup-1">Getting Setup</h3>
<p>Our script includes a small amount of CSS to show and hide content using <code>display: none</code> and <code>display: block</code>. It also includes an event listener and a few modern JavaScript methods.</p>
<h4 id="css">CSS</h4>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="fl">.accordion-content</span> <span class="kw">{</span>
    <span class="kw">display:</span> <span class="dt">none</span><span class="kw">;</span>
<span class="kw">}</span>

<span class="fl">.accordion-content.active</span> <span class="kw">{</span>
    <span class="kw">display:</span> <span class="dt">block</span><span class="kw">;</span>
<span class="kw">}</span></code></pre></div>
<h4 id="javascript-1">JavaScript</h4>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Listen for click events</span>
<span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Only run if the clicked link was an accordion toggle</span>
    <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>) ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="cf">if</span> ( <span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>) ) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-content.active&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>

<span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span></code></pre></div>
<h4 id="markup-1">Markup</h4>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;accordion-toggle&quot;</span><span class="ot"> href=</span><span class="st">&quot;#content&quot;</span><span class="kw">&gt;</span>Show Content<span class="kw">&lt;/a&gt;</span>

<span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;accordion-content&quot;</span><span class="ot"> id=</span><span class="st">&quot;content&quot;</span><span class="kw">&gt;</span>
    The content
<span class="kw">&lt;/div&gt;</span></code></pre></div>
<h3 id="planning-1">Planning</h3>
<p>Let’s take a quick inventory of what we’d like to accomplish.</p>
<ol style="list-style-type: decimal">
<li>Scope our code inside a function wrapper.</li>
<li>Add an initialization function.</li>
<li>Modularize our script.</li>
<li>Add a destroy function to under our initialization.</li>
<li>Let users pass in options to configure things.</li>
<li>Add developer hooks.</li>
</ol>
<h3 id="scoping-our-code-2">Scoping our code</h3>
<p>The first thing we want to do is add a functional wrapper around our code to keep it out of the global scope.</p>
<p>To maximize compatibility with module loaders, let’s use a UMD wrapper. We’ll paste our current code in, and change <code>accordion</code> from the boilerplate to <code>accordion</code>.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">(<span class="kw">function</span> (root<span class="op">,</span> factory) <span class="op">{</span>
    <span class="cf">if</span> ( <span class="kw">typeof</span> define <span class="op">===</span> <span class="st">&#39;function&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">define</span>.<span class="at">amd</span> ) <span class="op">{</span>
        <span class="at">define</span>([]<span class="op">,</span> <span class="at">factory</span>(root))<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> ( <span class="kw">typeof</span> exports <span class="op">===</span> <span class="st">&#39;object&#39;</span> ) <span class="op">{</span>
        <span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
        <span class="va">root</span>.<span class="at">accordion</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span>
<span class="op">}</span>)(<span class="kw">typeof</span> global <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> global : <span class="kw">this</span>.<span class="at">window</span> <span class="op">||</span> <span class="kw">this</span>.<span class="at">global</span><span class="op">,</span> <span class="kw">function</span> (root) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>

    <span class="co">// Redefine window</span>
    <span class="kw">var</span> window <span class="op">=</span> root<span class="op">;</span>

    <span class="co">// Listen for clicks on the document</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>

        <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
        <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>) ) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the target content</span>
        <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
        <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Prevent default link behavior</span>
        <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

        <span class="co">// If the content is already expanded, collapse it and quit</span>
        <span class="cf">if</span> ( <span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>) ) <span class="op">{</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
            <span class="cf">return</span><span class="op">;</span>
        <span class="op">}</span>

        <span class="co">// Get all accordion content, loop through it, and close it</span>
        <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-content.active&#39;</span>)<span class="op">;</span>
        <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="op">}</span>

        <span class="co">// Open our target content area</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>

    <span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span>

<span class="op">}</span>)<span class="op">;</span></code></pre></div>
<h3 id="add-an-initialization-method-1">Add an initialization method</h3>
<p>Now, let’s add an initialization function, so that it only runs if we explicitly call it.</p>
<p>Let’s add a placeholder object for our public methods, move our event listener to an <code>.init()</code> method, and return our public methods object.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">(<span class="kw">function</span> (root<span class="op">,</span> factory) <span class="op">{</span>
    <span class="cf">if</span> ( <span class="kw">typeof</span> define <span class="op">===</span> <span class="st">&#39;function&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">define</span>.<span class="at">amd</span> ) <span class="op">{</span>
        <span class="at">define</span>([]<span class="op">,</span> <span class="at">factory</span>(root))<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> ( <span class="kw">typeof</span> exports <span class="op">===</span> <span class="st">&#39;object&#39;</span> ) <span class="op">{</span>
        <span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
        <span class="va">root</span>.<span class="at">accordion</span> <span class="op">=</span> <span class="at">factory</span>(root)<span class="op">;</span>
    <span class="op">}</span>
<span class="op">}</span>)(<span class="kw">typeof</span> global <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> global : <span class="kw">this</span>.<span class="at">window</span> <span class="op">||</span> <span class="kw">this</span>.<span class="at">global</span><span class="op">,</span> <span class="kw">function</span> (root) <span class="op">{</span>

    <span class="st">&#39;use strict&#39;</span><span class="op">;</span>


    <span class="co">//</span>
    <span class="co">// Variables</span>
    <span class="co">//</span>

    <span class="kw">var</span> window <span class="op">=</span> root<span class="op">;</span> <span class="co">// Redefine window</span>
    <span class="kw">var</span> publicMethods <span class="op">=</span> <span class="op">{};</span> <span class="co">// Placeholder for public methods</span>


    <span class="co">//</span>
    <span class="co">// Methods</span>
    <span class="co">//</span>

    <span class="co">/**</span>
<span class="co">     * Initialize our script</span>
<span class="co">     */</span>
    <span class="va">publicMethods</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

        <span class="co">// Listen for clicks on the document</span>
        <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>

            <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
            <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>) ) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Get the target content</span>
            <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
            <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

            <span class="co">// Prevent default link behavior</span>
            <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

            <span class="co">// If the content is already expanded, collapse it and quit</span>
            <span class="cf">if</span> ( <span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>) ) <span class="op">{</span>
                <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
                <span class="cf">return</span><span class="op">;</span>
            <span class="op">}</span>

            <span class="co">// Get all accordion content, loop through it, and close it</span>
            <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-content.active&#39;</span>)<span class="op">;</span>
            <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
                accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
            <span class="op">}</span>

            <span class="co">// Open our target content area</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>

        <span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="op">};</span>


    <span class="co">//</span>
    <span class="co">// Return our public methods</span>
    <span class="co">//</span>

    <span class="cf">return</span> publicMethods<span class="op">;</span>

<span class="op">}</span>)<span class="op">;</span>

<span class="co">// Initialize our script</span>
<span class="va">accordion</span>.<span class="at">init</span>()<span class="op">;</span></code></pre></div>
<p>Let’s also add an initialization class, and make the CSS that hides our content dependant on it’s presence.</p>
<h4 id="javascript-2">JavaScript</h4>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Initialize our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Listen for clicks on the document</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">function</span> (event) <span class="op">{</span>

        <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
        <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>) ) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Get the target content</span>
        <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
        <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

        <span class="co">// Prevent default link behavior</span>
        <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

        <span class="co">// If the content is already expanded, collapse it and quit</span>
        <span class="cf">if</span> ( <span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>) ) <span class="op">{</span>
            <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
            <span class="cf">return</span><span class="op">;</span>
        <span class="op">}</span>

        <span class="co">// Get all accordion content, loop through it, and close it</span>
        <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-content.active&#39;</span>)<span class="op">;</span>
        <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
            accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="op">}</span>

        <span class="co">// Open our target content area</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>

        <span class="co">// Add an initialization class</span>
        <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

    <span class="op">},</span> <span class="kw">false</span>)<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<h4 id="css-1">CSS</h4>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="fl">.js-accordion</span> <span class="fl">.accordion-content</span> <span class="kw">{</span>
    <span class="kw">display:</span> <span class="dt">none</span><span class="kw">;</span>
<span class="kw">}</span>

<span class="fl">.accordion-content.active</span> <span class="kw">{</span>
    <span class="kw">display:</span> <span class="dt">block</span><span class="kw">;</span>
<span class="kw">}</span></code></pre></div>
<h3 id="modularize-our-script">Modularize our script</h3>
<p>Next, let’s break our script up into some smaller parts.</p>
<p>First, let’s pull everything in our event listener our into a standalone function. This will make it possible for us to remove the event listener later. We’ll pass in the <code>event</code> as an argument into our function.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">//</span>
<span class="co">// Methods</span>
<span class="co">//</span>

<span class="co">/**</span>
<span class="co"> * Function to run on click</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Event}</span><span class="co"> event The click event</span>
<span class="co"> */</span>
<span class="kw">var</span> clickHandler <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
    <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>) ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="cf">if</span> ( <span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>) ) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-content.active&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Initialize our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Listen for clicks on the document</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Add an initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>Then, let’s move all of our code that actually toggles visibility into it’s own function that we’ll call within our <code>clickHandler()</code>. We’ll need to pass in the <code>content</code> as an argument.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">//</span>
<span class="co">// Methods</span>
<span class="co">//</span>

<span class="co">/**</span>
<span class="co"> * Toggle accordion content visibility</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Node}</span><span class="co"> content  The content to show or hide</span>
<span class="co"> */</span>
<span class="kw">var</span> toggleAccordion <span class="op">=</span> <span class="kw">function</span> (content) <span class="op">{</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="cf">if</span> ( <span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;active&#39;</span>) ) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&#39;.accordion-content.active&#39;</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&#39;active&#39;</span>)<span class="op">;</span>

<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Function to run on click</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Event}</span><span class="co"> event The click event</span>
<span class="co"> */</span>
<span class="kw">var</span> clickHandler <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
    <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="st">&#39;accordion-toggle&#39;</span>) ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// Toggle accordion content visibility</span>
    <span class="at">toggleAccordion</span>(content)<span class="op">;</span>
<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Initialize our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Listen for clicks on the document</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Add an initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

<span class="op">};</span></code></pre></div>
<h3 id="add-a-destroy-function-1">Add a destroy function</h3>
<p>Now we can add a function to destroy our initialization. This is useful when we want to cancel our accordion or reinitialize it with some new options.</p>
<p>This will be a public method, and we’ll call it in our initialization method.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Destroy our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Remove our event listener</span>
    <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Remove our initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;js-accordion&#39;</span>)<span class="op">;</span>

<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Initialize our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Destroy any existing initializations</span>
    <span class="va">publicMethods</span>.<span class="at">destroy</span>()<span class="op">;</span>

    <span class="co">// Listen for clicks on the document</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Add an initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>If you open up the console tab in developer tools and run <code>accordion.destroy()</code>, all of the hidden content should become visible.</p>
<h3 id="add-user-options-1">Add user options</h3>
<p>Next, let’s add some options that users can configure themselves—things like selectors and initialization classes.</p>
<p>To get started, let’s set up our defaults as an object with key/value pairs, and add a <code>null</code> variable to hold our settings globally within our plugin.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">//</span>
<span class="co">// Variables</span>
<span class="co">//</span>

<span class="kw">var</span> window <span class="op">=</span> root<span class="op">;</span> <span class="co">// Redefine window</span>
<span class="kw">var</span> publicMethods <span class="op">=</span> <span class="op">{};</span> <span class="co">// Placeholder for public methods</span>
<span class="kw">var</span> settings<span class="op">;</span> <span class="co">// Settings placeholder</span>

<span class="co">// Defaults</span>
<span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>
    <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
    <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion-content&#39;</span><span class="op">,</span>
    <span class="dt">activeClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
    <span class="dt">initClass</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span>
<span class="op">};</span></code></pre></div>
<p>Now, let’s add a function to merge user settings into our defaults.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">//</span>
<span class="co">// Methods</span>
<span class="co">//</span>

<span class="co">/**</span>
<span class="co"> * Merge two or more objects together.</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Boolean}</span><span class="co">  deep     If true, do a deep (or recursive) merge [optional]</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co"> </span><span class="kw">{Object}</span><span class="co">   objects  The objects to merge together</span>
<span class="co"> * </span><span class="kw">@returns</span><span class="co"> {Object}          Merged values of defaults and options</span>
<span class="co"> */</span>
<span class="kw">var</span> extend <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Variables</span>
    <span class="kw">var</span> extended <span class="op">=</span> <span class="op">{};</span>
    <span class="kw">var</span> deep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>
    <span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>
    <span class="kw">var</span> length <span class="op">=</span> <span class="va">arguments</span>.<span class="at">length</span><span class="op">;</span>

    <span class="co">// Check if a deep merge</span>
    <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>( arguments[<span class="dv">0</span>] ) <span class="op">===</span> <span class="st">&#39;[object Boolean]&#39;</span> ) <span class="op">{</span>
        deep <span class="op">=</span> arguments[<span class="dv">0</span>]<span class="op">;</span>
        i<span class="op">++;</span>
    <span class="op">}</span>

    <span class="co">// Merge the object into the extended object</span>
    <span class="kw">var</span> merge <span class="op">=</span> <span class="kw">function</span> ( obj ) <span class="op">{</span>
        <span class="cf">for</span> ( <span class="kw">var</span> prop <span class="kw">in</span> obj ) <span class="op">{</span>
            <span class="cf">if</span> ( <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">hasOwnProperty</span>.<span class="at">call</span>( obj<span class="op">,</span> prop ) ) <span class="op">{</span>
                <span class="co">// If deep merge and property is an object, merge properties</span>
                <span class="cf">if</span> ( deep <span class="op">&amp;&amp;</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(obj[prop]) <span class="op">===</span> <span class="st">&#39;[object Object]&#39;</span> ) <span class="op">{</span>
                    extended[prop] <span class="op">=</span> <span class="at">extend</span>( <span class="kw">true</span><span class="op">,</span> extended[prop]<span class="op">,</span> obj[prop] )<span class="op">;</span>
                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
                    extended[prop] <span class="op">=</span> obj[prop]<span class="op">;</span>
                <span class="op">}</span>
            <span class="op">}</span>
        <span class="op">}</span>
    <span class="op">};</span>

    <span class="co">// Loop through each object and conduct a merge</span>
    <span class="cf">for</span> ( <span class="op">;</span> i <span class="op">&lt;</span> length<span class="op">;</span> i<span class="op">++</span> ) <span class="op">{</span>
        <span class="kw">var</span> obj <span class="op">=</span> arguments[i]<span class="op">;</span>
        <span class="at">merge</span>(obj)<span class="op">;</span>
    <span class="op">}</span>

    <span class="cf">return</span> extended<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>In our <code>publicMethods.init()</code> function, we’ll add an argument for options. We’ll also merge <code>options</code> into <code>defaults</code> and set them to the <code>settings</code> variable. We’ll omit the <code>var</code> before <code>settings</code> to modify our global variable instead of creating a new one.</p>
<p>When merging, we’ll pass our options in as <code>options || {}</code> so that if the user doesn’t provide any options, we’ll fall back to an empty object. This prevents our <code>extend</code> method from throwing an error.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Initialize our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

    <span class="co">// Destroy any existing initializations</span>
    <span class="va">publicMethods</span>.<span class="at">destroy</span>()<span class="op">;</span>

    <span class="co">// Merge options into defaults</span>
    settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

    <span class="co">// Listen for clicks on the document</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Add an initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; js-accordion&#39;</span><span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>We also want to reset the <code>settings</code> variable in our <code>publicMethods.destroy()</code> function. We can use that variable as a test to determine if the script is already initialized or not, and bail if this is the first initialization.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Destroy our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Check if the script is initialized</span>
    <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Remove our event listener</span>
    <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Remove our initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="st">&#39;js-accordion&#39;</span>)<span class="op">;</span>

    <span class="co">// Reset our settings</span>
    settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

<span class="op">};</span></code></pre></div>
<h4 id="using-our-settings-in-the-script">Using our settings in the script</h4>
<p>Finally, we need to use our merged settings in our script instead of our hand-coded values.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Toggle accordion content visibility</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Node}</span><span class="co"> content  The content to show or hide</span>
<span class="co"> */</span>
<span class="kw">var</span> toggleAccordion <span class="op">=</span> <span class="kw">function</span> (content) <span class="op">{</span>

    <span class="co">// If the content is already expanded, collapse it and quit</span>
    <span class="cf">if</span> ( <span class="va">content</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="va">settings</span>.<span class="at">activeClass</span>) ) <span class="op">{</span>
        <span class="va">content</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">activeClass</span>)<span class="op">;</span>
        <span class="cf">return</span><span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Get all accordion content, loop through it, and close it</span>
    <span class="kw">var</span> accordions <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="va">settings</span>.<span class="at">selectorContent</span> <span class="op">+</span> <span class="st">&#39;.&#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">activeClass</span>)<span class="op">;</span>
    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">accordions</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span>
        accordions[i].<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">activeClass</span>)<span class="op">;</span>
    <span class="op">}</span>

    <span class="co">// Open our target content area</span>
    <span class="va">content</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="va">settings</span>.<span class="at">activeClass</span>)<span class="op">;</span>

<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Function to run on click</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Event}</span><span class="co"> event The click event</span>
<span class="co"> */</span>
<span class="kw">var</span> clickHandler <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
    <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="va">classList</span>.<span class="at">contains</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span>) ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// Toggle accordion content visibility</span>
    <span class="at">toggleAccordion</span>(content)<span class="op">;</span>
<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Destroy our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">destroy</span> <span class="op">=</span> <span class="kw">function</span> () <span class="op">{</span>

    <span class="co">// Check if the script is initialized</span>
    <span class="cf">if</span> (<span class="op">!</span>settings) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Remove our event listener</span>
    <span class="va">document</span>.<span class="at">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Remove our initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="va">classList</span>.<span class="at">remove</span>(<span class="va">settings</span>.<span class="at">initClass</span>)<span class="op">;</span>

    <span class="co">// Reset our settings</span>
    settings <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>

<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Initialize our script</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">init</span> <span class="op">=</span> <span class="kw">function</span> (options) <span class="op">{</span>

    <span class="co">// Destroy any existing initializations</span>
    <span class="va">publicMethods</span>.<span class="at">destroy</span>()<span class="op">;</span>

    <span class="co">// Merge options into defaults</span>
    settings <span class="op">=</span> <span class="at">extend</span>(defaults<span class="op">,</span> options <span class="op">||</span> <span class="op">{}</span>)<span class="op">;</span>

    <span class="co">// Listen for clicks on the document</span>
    <span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickHandler<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>

    <span class="co">// Add an initialization class</span>
    <span class="va">document</span>.<span class="va">documentElement</span>.<span class="at">className</span> <span class="op">+=</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="va">settings</span>.<span class="at">initClass</span><span class="op">;</span>

<span class="op">};</span></code></pre></div>
<h4 id="beyond-class-based-selectors">Beyond class-based selectors</h4>
<p>The one snag here is with our <code>clickHandler()</code> function. Right now, it relies on <code>classList.contains()</code> to check if the clicked element is one of our accordion toggles.</p>
<p>Our selector is <code>.accordion-toggle</code>. That leading <code>.</code> will cause our <code>if</code> statement to fail, as <code>classList.contains()</code> uses just the class name, not the CSS selector associated with classes. It also doesn’t account for other types of selectors, like data attributes (<code>[data-accordion-toggle]</code>) or selectors with multiple classes (<code>.main .accordion-toggle</code>);</p>
<p>Instead, we want to use <code>.matches()</code>, which will return true whenever the selector(s) would match on the element in question.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Function to run on click</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Event}</span><span class="co"> event The click event</span>
<span class="co"> */</span>
<span class="kw">var</span> clickHandler <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
    <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="at">matches</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span>) ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// ...</span>

<span class="op">};</span></code></pre></div>
<p>The <code>.matches()</code> method has spotty browser support, and in some supporting browsers requires a vendor prefix (like <code>webkitMatches()</code>). Fortunately, a simple polyfill extends this to all browsers that support <code>querySelector</code>.</p>
<p>Let’s add this globally within our script.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="cf">if</span> (<span class="op">!</span><span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span>) <span class="op">{</span>
    <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matches</span> <span class="op">=</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">matchesSelector</span> <span class="op">||</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">mozMatchesSelector</span> <span class="op">||</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">msMatchesSelector</span> <span class="op">||</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">oMatchesSelector</span> <span class="op">||</span>
        <span class="va">Element</span>.<span class="va">prototype</span>.<span class="at">webkitMatchesSelector</span> <span class="op">||</span>
        <span class="kw">function</span>(s) <span class="op">{</span>
            <span class="kw">var</span> matches <span class="op">=</span> (<span class="kw">this</span>.<span class="at">document</span> <span class="op">||</span> <span class="kw">this</span>.<span class="at">ownerDocument</span>).<span class="at">querySelectorAll</span>(s)<span class="op">,</span>
                i <span class="op">=</span> <span class="va">matches</span>.<span class="at">length</span><span class="op">;</span>
            <span class="cf">while</span> (<span class="op">--</span>i <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> <span class="va">matches</span>.<span class="at">item</span>(i) <span class="op">!==</span> <span class="kw">this</span>) <span class="op">{}</span>
            <span class="cf">return</span> i <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span>
        <span class="op">};</span>
<span class="op">}</span></code></pre></div>
<h3 id="adding-developer-hooks">Adding developer hooks</h3>
<p>To make our plugin as flexible as possible, we also want to add hooks developers can use to extend functionality.</p>
<p>First, let’s make the <code>toggleAccordion()</code> method public, so that users can run it from other scripts. For example, imagine if a user wanted to dynamically open a specific piece of accordion content if a link in the navigation is clicked.</p>
<p>Don’t forget to change our function call in the <code>clickHandler()</code> method.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">/**</span>
<span class="co"> * Toggle accordion content visibility</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Node}</span><span class="co"> content  The content to show or hide</span>
<span class="co"> */</span>
<span class="va">publicMethods</span>.<span class="at">toggleAccordion</span> <span class="op">=</span> <span class="kw">function</span> (content) <span class="op">{</span>
    <span class="co">// ...</span>
<span class="op">};</span>

<span class="co">/**</span>
<span class="co"> * Function to run on click</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Event}</span><span class="co"> event The click event</span>
<span class="co"> */</span>
<span class="kw">var</span> clickHandler <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// ...</span>

    <span class="co">// Toggle accordion content visibility</span>
    <span class="va">publicMethods</span>.<span class="at">toggleAccordion</span>(content)<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>Next, let’s add callback functions that can be run before and after accordion content is toggled. These let developers add additional functionality to our plugin without having to touch the core code.</p>
<p>We’ll include these as empty functions in our <code>defaults</code> variable, and add them to our <code>clickHandler</code> function. Developers can pass their callbacks in with the <code>options</code> object.</p>
<p>We’ll also pass in the toggle element and content area as arguments, for maximum flexibility.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Defaults</span>
<span class="kw">var</span> defaults <span class="op">=</span> <span class="op">{</span>

    <span class="co">// Selectors</span>
    <span class="dt">selectorToggle</span><span class="op">:</span> <span class="st">&#39;.accordion-toggle&#39;</span><span class="op">,</span>
    <span class="dt">selectorContent</span><span class="op">:</span> <span class="st">&#39;.accordion-content&#39;</span><span class="op">,</span>
    <span class="dt">activeClass</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span>
    <span class="dt">initClass</span><span class="op">:</span> <span class="st">&#39;js-accordion&#39;</span><span class="op">,</span>

    <span class="co">// Callbacks</span>
    <span class="dt">callbackBefore</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{},</span>
    <span class="dt">callbackAfter</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{}</span>

<span class="op">};</span>

<span class="co">// ...</span>

<span class="co">/**</span>
<span class="co"> * Function to run on click</span>
<span class="co"> * </span><span class="kw">@param</span><span class="co">  </span><span class="kw">{Event}</span><span class="co"> event The click event</span>
<span class="co"> */</span>
<span class="kw">var</span> clickHandler <span class="op">=</span> <span class="kw">function</span> (event) <span class="op">{</span>

    <span class="co">// Bail if our clicked element doesn&#39;t have the .accordion-toggle class</span>
    <span class="cf">if</span> ( <span class="op">!</span><span class="va">event</span>.<span class="va">target</span>.<span class="at">matches</span>(<span class="va">settings</span>.<span class="at">selectorToggle</span>) ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Get the target content</span>
    <span class="kw">var</span> content <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="va">event</span>.<span class="va">target</span>.<span class="at">hash</span>)<span class="op">;</span>
    <span class="cf">if</span> ( <span class="op">!</span>content ) <span class="cf">return</span><span class="op">;</span>

    <span class="co">// Prevent default link behavior</span>
    <span class="va">event</span>.<span class="at">preventDefault</span>()<span class="op">;</span>

    <span class="co">// Run callback before toggling the accordion</span>
    <span class="va">settings</span>.<span class="at">callbackBefore</span>(<span class="va">event</span>.<span class="at">target</span><span class="op">,</span> content)<span class="op">;</span>

    <span class="co">// Toggle accordion content visibility</span>
    <span class="va">publicMethods</span>.<span class="at">toggleAccordion</span>(content)<span class="op">;</span>

    <span class="co">// Run callback after toggling the accordion</span>
    <span class="va">settings</span>.<span class="at">callbackAfter</span>(<span class="va">event</span>.<span class="at">target</span><span class="op">,</span> content)<span class="op">;</span>

<span class="op">};</span></code></pre></div>
<p>And with those last two changes, you’ve made a plugin that’s incredibly flexible and developer-friendly. Congrats!</p>
<h2 id="about-the-author">About the Author</h2>
<div class="figure">
<img src="assets/img/chris-ferdinandi.jpg" class="author-img" />

</div>
<p>Hi, I’m Chris Ferdinandi. I help people learn JavaScript.</p>
<p>I love pirates, puppies, and Pixar movies, and live near horse farms in rural Massachusetts. I run Go Make Things with Bailey Puppy, a lab-mix from Tennessee.</p>
<p>You can find me:</p>
<ul>
<li>On my website at <a href="https://gomakethings.com">GoMakeThings.com</a>.</li>
<li>By email at <script type="text/javascript">
<!--
h='&#x67;&#x6f;&#x6d;&#x61;&#x6b;&#x65;&#116;&#104;&#x69;&#110;&#x67;&#x73;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#x63;&#104;&#114;&#x69;&#x73;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'" clas'+'s="em' + 'ail">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#x63;&#104;&#114;&#x69;&#x73;&#32;&#x61;&#116;&#32;&#x67;&#x6f;&#x6d;&#x61;&#x6b;&#x65;&#116;&#104;&#x69;&#110;&#x67;&#x73;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;</noscript>.</li>
<li>On Twitter at <a href="https://twitter.com/ChrisFerdinandi"><span class="citation">@ChrisFerdinandi</span></a>.</li>
</ul>
<div class="break">

</div>
<script>
    ;(function (window, document, undefined) {

        'use strict';


        // Feature test
        var supports = 'querySelector' in document;
        if ( !supports ) return;


        //
        // Variables
        //


        var headings = document.querySelectorAll( 'h2' ); // Headings
        var toc = document.querySelector( '[data-toc]' ); // Table of contents container
        var links = '';         // Placeholder variables

        // Make sure headings and TOC container exist. Otherwise, bail.
        if ( headings.length < 1 || !toc ) return;


        //
        // Methods
        //

        /**
         * Give heading an ID if it's missing one
         * @param  {Node} heading The heading
         */
        var createID = function ( heading ) {

            // If the heading already has and ID, bail
            if ( heading.id ) return;

            // Otherwise, convert heading text to valid ID
            // Regex pattern: http://stackoverflow.com/a/9635698/1293256
            heading.id = heading.innerHTML.replace( /^[^a-z]+|[^\w:.-]+/gi, '_' ).toLowerCase();

        };

        /**
         * Create the table of contents link
         * @param  {Node} heading The heading
         */
        var createLink = function ( heading ) {
            links += '<li><a href="#' + heading.id + '">' + heading.innerHTML + '</a></li>';
        };


        //
        // Inits
        //

        // Create the links
        for ( var i = 0; i < headings.length; i++ ) {
            createID( headings[i] ); // If the heading has no ID, give it one
            createLink( headings[i] ); // Create link
        }

        // Inject TOC into the DOM
        toc.innerHTML = '<h2>Table of Contents</h2><ol>' + links + '</ol>';

    })(window, document);

    /*! smooth-scroll v10.3.1 | (c) 2017 Chris Ferdinandi | MIT License | http://github.com/cferdinandi/smooth-scroll */
    !(function(e,t){"function"==typeof define&&define.amd?define([],t(e)):"object"==typeof exports?module.exports=t(e):e.smoothScroll=t(e)})("undefined"!=typeof global?global:this.window||this.global,(function(e){"use strict";var t,n,o,r,a,c,l,i={},u="querySelector"in document&&"addEventListener"in e,s={selector:"[data-scroll]",selectorHeader:null,speed:500,easing:"easeInOutCubic",offset:0,callback:function(){}},f=function(){var e={},t=!1,n=0,o=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(t=arguments[0],n++);for(;n<o;n++){var r=arguments[n];!(function(n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t&&"[object Object]"===Object.prototype.toString.call(n[o])?e[o]=f(!0,e[o],n[o]):e[o]=n[o])})(r)}return e},d=function(e){return Math.max(e.scrollHeight,e.offsetHeight,e.clientHeight)},h=function(e,t){for(Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),n=t.length;--n>=0&&t.item(n)!==this;);return n>-1});e&&e!==document;e=e.parentNode)if(e.matches(t))return e;return null},m=function(e){"#"===e.charAt(0)&&(e=e.substr(1));for(var t,n=String(e),o=n.length,r=-1,a="",c=n.charCodeAt(0);++r<o;){if(0===(t=n.charCodeAt(r)))throw new InvalidCharacterError("Invalid character: the input contains U+0000.");a+=t>=1&&t<=31||127==t||0===r&&t>=48&&t<=57||1===r&&t>=48&&t<=57&&45===c?"\\"+t.toString(16)+" ":t>=128||45===t||95===t||t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122?n.charAt(r):"\\"+n.charAt(r)}return"#"+a},p=function(e,t){var n;return"easeInQuad"===e&&(n=t*t),"easeOutQuad"===e&&(n=t*(2-t)),"easeInOutQuad"===e&&(n=t<.5?2*t*t:(4-2*t)*t-1),"easeInCubic"===e&&(n=t*t*t),"easeOutCubic"===e&&(n=--t*t*t+1),"easeInOutCubic"===e&&(n=t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1),"easeInQuart"===e&&(n=t*t*t*t),"easeOutQuart"===e&&(n=1- --t*t*t*t),"easeInOutQuart"===e&&(n=t<.5?8*t*t*t*t:1-8*--t*t*t*t),"easeInQuint"===e&&(n=t*t*t*t*t),"easeOutQuint"===e&&(n=1+--t*t*t*t*t),"easeInOutQuint"===e&&(n=t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t),n||t},g=function(e,t,n){var o=0;if(e.offsetParent)do{o+=e.offsetTop,e=e.offsetParent}while(e);return o=Math.max(o-t-n,0),Math.min(o,y()-b())},b=function(){return Math.max(document.documentElement.clientHeight,e.innerHeight||0)},y=function(){return Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)},v=function(e){return e&&"object"==typeof JSON&&"function"==typeof JSON.parse?JSON.parse(e):{}},O=function(e){return e?d(e)+e.offsetTop:0},S=function(t,n,o){o||(t.focus(),document.activeElement.id!==t.id&&(t.setAttribute("tabindex","-1"),t.focus(),t.style.outline="none"),e.scrollTo(0,n))};i.animateScroll=function(n,o,c){var i=v(o?o.getAttribute("data-options"):null),u=f(t||s,c||{},i),d="[object Number]"===Object.prototype.toString.call(n),h=d||!n.tagName?null:n;if(d||h){var m=e.pageYOffset;u.selectorHeader&&!r&&(r=document.querySelector(u.selectorHeader)),a||(a=O(r));var b,E,I=d?n:g(h,a,parseInt("function"==typeof u.offset?u.offset():u.offset,10)),H=I-m,A=y(),j=0,C=function(t,r,a){var c=e.pageYOffset;(t==r||c==r||e.innerHeight+c>=A)&&(clearInterval(a),S(n,r,d),u.callback(n,o))},M=function(){j+=16,b=j/parseInt(u.speed,10),b=b>1?1:b,E=m+H*p(u.easing,b),e.scrollTo(0,Math.floor(E)),C(E,I,l)};0===e.pageYOffset&&e.scrollTo(0,0),(function(){clearInterval(l),l=setInterval(M,16)})()}};var E=function(t){try{m(decodeURIComponent(e.location.hash))}catch(t){m(e.location.hash)}n&&(n.id=n.getAttribute("data-scroll-id"),i.animateScroll(n,o),n=null,o=null)},I=function(r){if(0===r.button&&!r.metaKey&&!r.ctrlKey&&(o=h(r.target,t.selector))&&"a"===o.tagName.toLowerCase()&&o.hostname===e.location.hostname&&o.pathname===e.location.pathname&&/#/.test(o.href)){var a;try{a=m(decodeURIComponent(o.hash))}catch(e){a=m(o.hash)}if("#"===a){r.preventDefault(),n=document.body;var c=n.id?n.id:"smooth-scroll-top";return n.setAttribute("data-scroll-id",c),n.id="",void(e.location.hash.substring(1)===c?E():e.location.hash=c)}n=document.querySelector(a),n&&(n.setAttribute("data-scroll-id",n.id),n.id="",o.hash===e.location.hash&&(r.preventDefault(),E()))}},H=function(e){c||(c=setTimeout((function(){c=null,a=O(r)}),66))};return i.destroy=function(){t&&(document.removeEventListener("click",I,!1),e.removeEventListener("resize",H,!1),t=null,n=null,o=null,r=null,a=null,c=null,l=null)},i.init=function(n){u&&(i.destroy(),t=f(s,n||{}),r=t.selectorHeader?document.querySelector(t.selectorHeader):null,a=O(r),document.addEventListener("click",I,!1),e.addEventListener("hashchange",E,!1),r&&e.addEventListener("resize",H,!1))},i}));
    smoothScroll.init({
        selector: 'a[href*="#"]'
    })
</script>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://polyfill.io" class="uri">https://polyfill.io</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p><a href="https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/helper-methods/extend.js" class="uri">https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/helper-methods/extend.js</a><a href="#fnref2">↩</a></p></li>
<li id="fn3"><p><a href="https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/polyfills/matches.js" class="uri">https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/polyfills/matches.js</a><a href="#fnref3">↩</a></p></li>
<li id="fn4"><p><a href="https://gomakethings.com/attaching-multiple-elements-to-a-single-event-listener-in-vanilla-js/" class="uri">https://gomakethings.com/attaching-multiple-elements-to-a-single-event-listener-in-vanilla-js/</a><a href="#fnref4">↩</a></p></li>
<li id="fn5"><p><a href="https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/polyfills/CustomEvent.js" class="uri">https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/polyfills/CustomEvent.js</a><a href="#fnref5">↩</a></p></li>
<li id="fn6"><p><a href="https://github.com/cferdinandi/writing-plugins-source-code/" class="uri">https://github.com/cferdinandi/writing-plugins-source-code/</a><a href="#fnref6">↩</a></p></li>
<li id="fn7"><p><a href="https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/helper-methods/extend.js" class="uri">https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/helper-methods/extend.js</a><a href="#fnref7">↩</a></p></li>
<li id="fn8"><p><a href="https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/polyfills/CustomEvent.js" class="uri">https://github.com/cferdinandi/vanilla-javascript-cheat-sheet/blob/master/polyfills/CustomEvent.js</a><a href="#fnref8">↩</a></p></li>
<li id="fn9"><p><a href="https://github.com/cferdinandi/writing-plugins-source-code/" class="uri">https://github.com/cferdinandi/writing-plugins-source-code/</a><a href="#fnref9">↩</a></p></li>
</ol>
</div>
</body>
</html>
